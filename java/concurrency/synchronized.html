<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.46" />
    <meta name="theme" content="VuePress Theme Hope" />
    <link rel="icon" href="/images/favicon.ico"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>🔴 Synchronized | liuxianzhishou</title><meta name="description" content="一步一罪化，一步一莲华">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.7120bfc5.css">
    <link rel="modulepreload" href="/assets/app.5aebcaaa.js"><link rel="modulepreload" href="/assets/synchronized.html.5d1a6ddb.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/synchronized.html.c2e89989.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/" class="brand"><!----><!----><span class="site-name hide-in-pad">liuxianzhishou</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="首页"><!---->首页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/proj/%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90.html" class="nav-link" aria-label="项目文档"><!---->项目文档<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title"><!---->Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java/basic/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" class="nav-link" aria-label="Java 基础"><!---->Java 基础<!----></a></li><li class="dropdown-item"><a href="/java/collection/ArrayList.html" class="nav-link" aria-label="Java 集合"><!---->Java 集合<!----></a></li><li class="dropdown-item"><a aria-current="page" href="/java/concurrency/synchronized.html" class="router-link-active router-link-exact-active nav-link active" aria-label="Java 并发 &amp; 多线程"><!---->Java 并发 &amp; 多线程<!----></a></li><li class="dropdown-item"><a href="/java/jvm/%E4%B8%80%E3%80%81%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.html" class="nav-link" aria-label="JVM"><!---->JVM<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title"><!---->数据库</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/db/mysql/MySQL%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86.html" class="nav-link" aria-label="MySQL"><!---->MySQL<!----></a></li><li class="dropdown-item"><a href="/db/redis/sds.html" class="nav-link" aria-label="Redis"><!---->Redis<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="框架中间件"><span class="title"><!---->框架中间件</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/frame/spring/Spring.html" class="nav-link" aria-label="spring"><!---->spring<!----></a></li><li class="dropdown-item"><a href="/frame/tomcat/tom.html" class="nav-link" aria-label="Tomcat"><!---->Tomcat<!----></a></li><li class="dropdown-item"><a href="/frame/mybatis/mybatis.html" class="nav-link" aria-label="MyBatis"><!---->MyBatis<!----></a></li><li class="dropdown-item"><a href="/frame/rpc/rpc.html" class="nav-link" aria-label="RPC"><!---->RPC<!----></a></li><li class="dropdown-item"><a href="/middleware/zookeeper/zo1.html" class="nav-link" aria-label="zookeeper"><!---->zookeeper<!----></a></li><li class="dropdown-item"><a href="/middleware/mq/rabbit.html" class="nav-link" aria-label="消息队列"><!---->消息队列<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="设计模式"><span class="title"><!---->设计模式</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/design/summary/%E6%80%BB%E8%A7%88.html" class="nav-link" aria-label="总览"><!---->总览<!----></a></li><li class="dropdown-item"><a href="/design/create/%E5%8D%95%E4%BE%8B.html" class="nav-link" aria-label="创建型"><!---->创建型<!----></a></li><li class="dropdown-item"><a href="/design/struct/%E9%80%82%E9%85%8D%E5%99%A8.html" class="nav-link" aria-label="结构型"><!---->结构型<!----></a></li><li class="dropdown-item"><a href="/design/behavior/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95.html" class="nav-link" aria-label="行为型"><!---->行为型<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="操作系统"><span class="title"><!---->操作系统</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/os/system/sys.html" class="nav-link" aria-label="操作系统"><!---->操作系统<!----></a></li><li class="dropdown-item"><a href="/os/linux/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html" class="nav-link" aria-label="Linux"><!---->Linux<!----></a></li><li class="dropdown-item"><a href="/os/docker/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html" class="nav-link" aria-label="Docker"><!---->Docker<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="计算机网络"><span class="title"><!---->计算机网络</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/network/summary/basic.html" class="nav-link" aria-label="总览"><!---->总览<!----></a></li><li class="dropdown-item"><a href="/network/http/http.html" class="nav-link" aria-label="应用层"><!---->应用层<!----></a></li><li class="dropdown-item"><a href="/network/tcp/tcp.html" class="nav-link" aria-label="传输层"><!---->传输层<!----></a></li><li class="dropdown-item"><a href="/network/ip/ip.html" class="nav-link" aria-label="网络层"><!---->网络层<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/distributed/%E5%88%86%E5%B8%83%E5%BC%8F.html" class="nav-link" aria-label="分布式"><!---->分布式<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="算法"><span class="title"><!---->算法</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/algorithm/array/307.html" class="nav-link" aria-label="数组"><!---->数组<!----></a></li><li class="dropdown-item"><a href="/algorithm/list/460.html" class="nav-link" aria-label="链表"><!---->链表<!----></a></li><li class="dropdown-item"><a href="/algorithm/hash/532.html" class="nav-link" aria-label="哈希表"><!---->哈希表<!----></a></li><li class="dropdown-item"><a href="/algorithm/stack/218.html" class="nav-link" aria-label="栈 &amp; 队列"><!---->栈 &amp; 队列<!----></a></li><li class="dropdown-item"><a href="/algorithm/string/28.html" class="nav-link" aria-label="字符串"><!---->字符串<!----></a></li><li class="dropdown-item"><a href="/algorithm/tree/144%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E5%89%8D%E5%BA%8F%E9%81%8D%E5%8E%86.html" class="nav-link" aria-label="树"><!---->树<!----></a></li><li class="dropdown-item"><a href="/algorithm/backtrace/37%E8%A7%A3%E6%95%B0%E7%8B%AC.html" class="nav-link" aria-label="回溯"><!---->回溯<!----></a></li><li class="dropdown-item"><a href="/algorithm/dp/300%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97.html" class="nav-link" aria-label="动态规划"><!---->动态规划<!----></a></li><li class="dropdown-item"><a href="/algorithm/sort/327.html" class="nav-link" aria-label="排序"><!---->排序<!----></a></li><li class="dropdown-item"><a href="/algorithm/graph/126.html" class="nav-link" aria-label="图"><!---->图<!----></a></li><li class="dropdown-item"><a href="/algorithm/extra/685.html" class="nav-link" aria-label="补充"><!---->补充<!----></a></li><li class="dropdown-item"><a href="/algorithm/thread/1114.html" class="nav-link" aria-label="多线程"><!---->多线程<!----></a></li><li class="dropdown-item"><a href="/algorithm/offer/03.html" class="nav-link" aria-label="剑指 Offer"><!---->剑指 Offer<!----></a></li><li class="dropdown-item"><a href="/algorithm/comp/01.html" class="nav-link" aria-label="竞赛"><!---->竞赛<!----></a></li></ul></button></div></div></nav><!----></div><div class="navbar-right"><!----><div class="nav-item"><!----></div><!----><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/java/concurrency/synchronized.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="🔴 Synchronized"><!---->🔴 Synchronized<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-用法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. 用法"><!---->1. 用法<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-修饰静态方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1) 修饰静态方法"><!---->1) 修饰静态方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-修饰实例方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2) 修饰实例方法"><!---->2) 修饰实例方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-修饰代码块" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3) 修饰代码块"><!---->3) 修饰代码块<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-底层原理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. 底层原理"><!---->2. 底层原理<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-同步方法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1) 同步方法"><!---->1) 同步方法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-同步代码块" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2) 同步代码块"><!---->2) 同步代码块<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-monitor-原理解析" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3) monitor 原理解析"><!---->3) monitor 原理解析<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-锁优化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3. 锁优化"><!---->3. 锁优化<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#锁升级流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="锁升级流程"><!---->锁升级流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-偏向锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1) 偏向锁"><!---->1) 偏向锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-轻量级锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2) 轻量级锁"><!---->2) 轻量级锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-锁消除" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3) 锁消除"><!---->3) 锁消除<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_4-锁粗化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4) 锁粗化"><!---->4) 锁粗化<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_4-特点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. 特点"><!---->4. 特点<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-有序性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1) 有序性"><!---->1) 有序性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-可见性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2) 可见性"><!---->2) 可见性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-原子性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3) 原子性"><!---->3) 原子性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_4-可重入性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4) 可重入性"><!---->4) 可重入性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_5-独占性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5) 独占性"><!---->5) 独占性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_6-不可中断性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6) 不可中断性"><!---->6) 不可中断性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_7-非公平锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7) 非公平锁"><!---->7) 非公平锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrency/synchronized.html#_8-自动释放锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8) 自动释放锁"><!---->8) 自动释放锁<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/java/concurrency/volatile.html" class="nav-link sidebar-link sidebar-page" aria-label="🟠 volatile"><!---->🟠 volatile<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/cas.html" class="nav-link sidebar-link sidebar-page" aria-label="🔘 CAS"><!---->🔘 CAS<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/Thread.html" class="nav-link sidebar-link sidebar-page" aria-label="🟤 Thread"><!---->🟤 Thread<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/lockS.html" class="nav-link sidebar-link sidebar-page" aria-label="⭕ LockSupport"><!---->⭕ LockSupport<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/ThreadLocal.html" class="nav-link sidebar-link sidebar-page" aria-label="🟡 ThreadLocal"><!---->🟡 ThreadLocal<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/rand.html" class="nav-link sidebar-link sidebar-page" aria-label="🟨 ThreadLocalRandom"><!---->🟨 ThreadLocalRandom<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/ThreadPoolExecutor.html" class="nav-link sidebar-link sidebar-page" aria-label="🟢 ThreadPoolExecutor"><!---->🟢 ThreadPoolExecutor<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/forkJoin.html" class="nav-link sidebar-link sidebar-page" aria-label="🟩 ForkJoinPool"><!---->🟩 ForkJoinPool<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/AbstractQueuedSynchronizer.html" class="nav-link sidebar-link sidebar-page" aria-label="🔵 AQS"><!---->🔵 AQS<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/reL.html" class="nav-link sidebar-link sidebar-page" aria-label="🔷 ReentrantLock"><!---->🔷 ReentrantLock<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/readWriteLock.html" class="nav-link sidebar-link sidebar-page" aria-label="💠 ReentrantReadWriteLock"><!---->💠 ReentrantReadWriteLock<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/StampedLock.html" class="nav-link sidebar-link sidebar-page" aria-label="🔹 StampedLock"><!---->🔹 StampedLock<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/CountDownLatch.html" class="nav-link sidebar-link sidebar-page" aria-label="🔸 CountDownLatch"><!---->🔸 CountDownLatch<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/CyclicBarrier.html" class="nav-link sidebar-link sidebar-page" aria-label="🔶 CyclicBarrier"><!---->🔶 CyclicBarrier<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/Semaphore.html" class="nav-link sidebar-link sidebar-page" aria-label="🔺 Semaphore"><!---->🔺 Semaphore<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/atomic.html" class="nav-link sidebar-link sidebar-page" aria-label="Ⓜ️ Atomic &amp; Unsafe"><!---->Ⓜ️ Atomic &amp; Unsafe<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrency/deadLock.html" class="nav-link sidebar-link sidebar-page" aria-label="🟣 死锁"><!---->🟣 死锁<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->🔴 Synchronized</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="author-item">吞佛童子</span></span><span property="author" content="吞佛童子"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年6月20日</span><meta property="datePublished" content="2022-06-20T12:24:47.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li class="category category4" role>Java</li><meta property="articleSection" content="Java"></ul></span><span aria-label="标签🏷" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag8" role>concurrency</li></ul><meta property="keywords" content="concurrency"></span><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 10 分钟</span><meta property="timeRequired" content="PT10M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-用法" class="router-link-active router-link-exact-active toc-link level2">1. 用法</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-修饰静态方法" class="router-link-active router-link-exact-active toc-link level3">1) 修饰静态方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-修饰实例方法" class="router-link-active router-link-exact-active toc-link level3">2) 修饰实例方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-修饰代码块" class="router-link-active router-link-exact-active toc-link level3">3) 修饰代码块</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-底层原理" class="router-link-active router-link-exact-active toc-link level2">2. 底层原理</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-同步方法" class="router-link-active router-link-exact-active toc-link level3">1) 同步方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-同步代码块" class="router-link-active router-link-exact-active toc-link level3">2) 同步代码块</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-monitor-原理解析" class="router-link-active router-link-exact-active toc-link level3">3) monitor 原理解析</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-锁优化" class="router-link-active router-link-exact-active toc-link level2">3. 锁优化</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#锁升级流程" class="router-link-active router-link-exact-active toc-link level3">锁升级流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-偏向锁" class="router-link-active router-link-exact-active toc-link level3">1) 偏向锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-轻量级锁" class="router-link-active router-link-exact-active toc-link level3">2) 轻量级锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-锁消除" class="router-link-active router-link-exact-active toc-link level3">3) 锁消除</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_4-锁粗化" class="router-link-active router-link-exact-active toc-link level3">4) 锁粗化</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_4-特点" class="router-link-active router-link-exact-active toc-link level2">4. 特点</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_1-有序性" class="router-link-active router-link-exact-active toc-link level3">1) 有序性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_2-可见性" class="router-link-active router-link-exact-active toc-link level3">2) 可见性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_3-原子性" class="router-link-active router-link-exact-active toc-link level3">3) 原子性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_4-可重入性" class="router-link-active router-link-exact-active toc-link level3">4) 可重入性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_5-独占性" class="router-link-active router-link-exact-active toc-link level3">5) 独占性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_6-不可中断性" class="router-link-active router-link-exact-active toc-link level3">6) 不可中断性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_7-非公平锁" class="router-link-active router-link-exact-active toc-link level3">7) 非公平锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrency/synchronized.html#_8-自动释放锁" class="router-link-active router-link-exact-active toc-link level3">8) 自动释放锁</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="synchronized" tabindex="-1"><a class="header-anchor" href="#synchronized" aria-hidden="true">#</a> 🔴 Synchronized</h1><h2 id="_1-用法" tabindex="-1"><a class="header-anchor" href="#_1-用法" aria-hidden="true">#</a> 1. 用法</h2><h3 id="_1-修饰静态方法" tabindex="-1"><a class="header-anchor" href="#_1-修饰静态方法" aria-hidden="true">#</a> 1) 修饰静态方法</h3><ul><li>作用对象为： <strong>Class 类</strong></li><li>多线程并发访问时，只能有一个线程进入，获得<strong>类锁</strong>，其他线程阻塞等待，但在此期间线程仍然可以访问其他方法</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-修饰实例方法" tabindex="-1"><a class="header-anchor" href="#_2-修饰实例方法" aria-hidden="true">#</a> 2) 修饰实例方法</h3><ul><li>作用对象为： <strong>实例类</strong></li><li>多线程并发访问时，只能有一个线程进入，获得<strong>对象内置锁</strong>，其他线程阻塞等待，但在此期间线程仍然可以访问其他方法</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-修饰代码块" tabindex="-1"><a class="header-anchor" href="#_3-修饰代码块" aria-hidden="true">#</a> 3) 修饰代码块</h3><ul><li>作用对象为： <strong>括号内的对象</strong></li><li>多线程并发访问时，只能有一个线程进入，根据括号中的对象或者是类，获得相应的<strong>对象内置锁</strong> | <strong>类锁</strong></li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//获得了String的类锁</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>每个类都有一个类锁，类的每个实例对象也有一个内置锁，它们是互不干扰的， 即，一个线程可以同时获得类锁和该类实例化对象的内置锁， 当线程访问非 <code>synchronized</code> 修饰的方法时，并不需要获得锁，因此不会产生阻塞</p></blockquote><hr><h2 id="_2-底层原理" tabindex="-1"><a class="header-anchor" href="#_2-底层原理" aria-hidden="true">#</a> 2. 底层原理</h2><h3 id="_1-同步方法" tabindex="-1"><a class="header-anchor" href="#_1-同步方法" aria-hidden="true">#</a> 1) 同步方法</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">doSth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>javac SynchronizedTest .java</code> 然后 <code>javap -c SynchronizedTest</code> 反编译后看汇编指令</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code> public synchronized void doSth<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC, ACC_SYNCHRONIZED // ☆☆☆
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: getstatic     <span class="token comment">#2                  </span>
         <span class="token number">3</span>: ldc           <span class="token comment">#3    </span>
         <span class="token number">5</span>: invokevirtual <span class="token comment">#4                  </span>
         <span class="token number">8</span>: <span class="token builtin class-name">return</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>同步方法的常量池中会有一个 <code>ACC_SYNCHRONIZED</code> 标志</li><li>当某个线程要访问某个方法的时候，会检查是否有 <code>ACC_SYNCHRONIZED</code>，如果有设置，则需要先获得<strong>监视器锁</strong>，然后开始执行方法，方法执行之后再释放监视器锁</li><li>如果在方法执行过程中，发生了异常，并且方法内部并没有处理该异常，那么在异常被抛到方法外面<strong>之前</strong>监视器锁会被自动释放</li></ul><h3 id="_2-同步代码块" tabindex="-1"><a class="header-anchor" href="#_2-同步代码块" aria-hidden="true">#</a> 2) 同步代码块</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSth1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">SynchronizedTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>javac SynchronizedTest .java</code> 然后 <code>javap -c SynchronizedTest</code> 反编译后看汇编指令</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>  public void doSth1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: ldc           <span class="token comment">#5                 </span>
         <span class="token number">2</span>: dup
         <span class="token number">3</span>: astore_1
         <span class="token number">4</span>: monitorenter  //   ☆☆☆
         <span class="token number">5</span>: getstatic     <span class="token comment">#2                  </span>
         <span class="token number">8</span>: ldc           <span class="token comment">#3                  </span>
        <span class="token number">10</span>: invokevirtual <span class="token comment">#4                </span>
        <span class="token number">13</span>: aload_1
        <span class="token number">14</span>: monitorexit  //正常时 ☆☆☆
        <span class="token number">15</span>: goto          <span class="token number">23</span>
        <span class="token number">18</span>: astore_2
        <span class="token number">19</span>: aload_1
        <span class="token number">20</span>: monitorexit  // 异常时 ☆☆☆
        <span class="token number">21</span>: aload_2
        <span class="token number">22</span>: athrow
        <span class="token number">23</span>: <span class="token builtin class-name">return</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>每个对象维护着一个记录着被锁次数的计数器。未被锁定的对象的该计数器为0</li><li>当一个线程获得锁（执行 <code>monitorenter</code>）后，该计数器自增变为 1 ，当同一个线程再次获得该对象的锁的时候，计数器再次自增</li><li>当同一个线程释放锁（执行 <code>monitorexit</code>）的时候，计数器再自减。</li><li>当计数器为0的时候，锁将被释放，其他线程便可以获得锁</li></ul><h3 id="_3-monitor-原理解析" tabindex="-1"><a class="header-anchor" href="#_3-monitor-原理解析" aria-hidden="true">#</a> 3) monitor 原理解析</h3><ul><li><code>HotSpot</code> 中，<code>monitor</code> 底层是由 <code>ObjectMonitor</code> 实现的，数据结构如下：</li><li>位于 <code>HotSpot</code> 虚拟机源码 <code>ObjectMonitor.hpp</code> 文件，<code>C++</code> 实现</li><li><a href="https://github.com/openjdk/jdk/blob/jdk8-b120/hotspot/src/share/vm/runtime/objectMonitor.hpp" target="_blank" rel="noopener noreferrer">源码地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>class ObjectMonitor <span class="token punctuation">{</span>
  <span class="token comment">// 构造函数</span>
  <span class="token function">ObjectMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _header       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
    _count        <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">//记录数</span>
    _waiters      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    _recursions   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">//锁的重入次数</span>
    _object       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    _owner        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>   <span class="token comment">//指向持有 ObjectMonitor 对象的线程</span>
    _WaitSet      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>   <span class="token comment">//调用wait后，线程会被加入到_WaitSet</span>
    _WaitSetLock  <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _Responsible  <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _succ         <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _cxq          <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>  <span class="token comment">// 多线程竞争锁进入时的单向链表</span>
    FreeNext      <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _EntryList    <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>  <span class="token comment">//等待获取锁的线程，会被加入到该列表</span>
    _SpinFreq     <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _SpinClock    <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    OwnerIsThread <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _previous_owner_tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
    <span class="token comment">// 线程尝试获取锁  </span>
    bool ObjectMonitor<span class="token operator">::</span><span class="token function">try_enter</span><span class="token punctuation">(</span>Thread<span class="token operator">*</span> THREAD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>THREAD <span class="token operator">!=</span> _owner<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 该对象锁之前不是本线程获取</span>
        <span class="token comment">// 当前线程尝试获取 对象锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>THREAD<span class="token operator">-&gt;</span><span class="token function">is_lock_owned</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>_owner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取成功</span>
           <span class="token function">assert</span><span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;internal state error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只能说明在此之前 锁的重入次数 == 0</span>
           _owner <span class="token operator">=</span> THREAD <span class="token punctuation">;</span> <span class="token comment">// 设置相关属性的值</span>
           _recursions <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
           OwnerIsThread <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
           <span class="token keyword">return</span> true<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 尝试修改 _owner 指针为 当前线程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> false<span class="token punctuation">;</span> <span class="token comment">// 修改失败，返回 false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> true<span class="token punctuation">;</span> <span class="token comment">// 修改成功</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 本线程再次获取 对象锁</span>
        _recursions<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> true<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// </span>
    <span class="token keyword">void</span> ATTR ObjectMonitor<span class="token operator">::</span><span class="token function">enter</span><span class="token punctuation">(</span>TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Thread <span class="token operator">*</span> <span class="token keyword">const</span> Self <span class="token operator">=</span> THREAD <span class="token punctuation">;</span>
      <span class="token keyword">void</span> <span class="token operator">*</span> cur <span class="token punctuation">;</span>
    
      cur <span class="token operator">=</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>Self<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token comment">// 修改 _owner 指针为 当前线程，失败，返回</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">assert</span> <span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span>   <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token function">assert</span> <span class="token punctuation">(</span>_owner      <span class="token operator">==</span> Self<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// 成功修改 _owner 指针为 当前线程</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">==</span> Self<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         _recursions <span class="token operator">++</span> <span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Self<span class="token operator">-&gt;</span><span class="token function">is_lock_owned</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;internal state error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _recursions <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
        _owner <span class="token operator">=</span> Self <span class="token punctuation">;</span>
        OwnerIsThread <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    
      <span class="token comment">// 我们遇到了真正的争论。</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>Self<span class="token operator">-&gt;</span>_Stalled <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      Self<span class="token operator">-&gt;</span>_Stalled <span class="token operator">=</span> <span class="token class-name">intptr_t</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    
      <span class="token comment">// 短暂 自旋</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Knob_SpinEarly <span class="token operator">&amp;&amp;</span> <span class="token function">TrySpin</span> <span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Self      <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token function">assert</span> <span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span>    <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oop<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> markOopDesc<span class="token operator">::</span><span class="token function">encode</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         Self<span class="token operator">-&gt;</span>_Stalled <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    
      <span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">!=</span> Self          <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>_succ  <span class="token operator">!=</span> Self          <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>Self<span class="token operator">-&gt;</span><span class="token function">is_Java_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      JavaThread <span class="token operator">*</span> jt <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> Self <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token operator">!</span>SafepointSynchronize<span class="token operator">::</span><span class="token function">is_at_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>jt<span class="token operator">-&gt;</span><span class="token function">thread_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> _thread_blocked   <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>this<span class="token operator">-&gt;</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span>  <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>_count <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    
      <span class="token comment">// count ++</span>
      Atomic<span class="token operator">::</span><span class="token function">inc_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
      EventJavaMonitorEnter event<span class="token punctuation">;</span>
    
      <span class="token punctuation">{</span> <span class="token comment">// 更改 java 线程状态以指示在监视器输入时被阻止。</span>
        JavaThreadBlockedOnMonitorEnterState <span class="token function">jtbmes</span><span class="token punctuation">(</span>jt<span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token function">DTRACE_MONITOR_PROBE</span><span class="token punctuation">(</span>contended__enter<span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>JvmtiExport<span class="token operator">::</span><span class="token function">should_post_monitor_contended_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          JvmtiExport<span class="token operator">::</span><span class="token function">post_monitor_contended_enter</span><span class="token punctuation">(</span>jt<span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        OSThreadContendState <span class="token function">osts</span><span class="token punctuation">(</span>Self<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ThreadBlockInVM <span class="token function">tbivm</span><span class="token punctuation">(</span>jt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        Self<span class="token operator">-&gt;</span><span class="token function">set_current_pending_monitor</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// TODO-FIXME：将以下 for(;;) 循环更改为直线代码。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          jt<span class="token operator">-&gt;</span><span class="token function">set_suspend_equivalent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 由 handle_special_suspend_equivalent_condition() 或 java_suspend_self() 清除</span>
          <span class="token function">EnterI</span> <span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ExitSuspendEquivalent</span><span class="token punctuation">(</span>jt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>

          <span class="token comment">// 我们已经获得了竞争监视器，但是在我们等待时，另一个线程暂停了我们。我们不想在暂停时进入监视器，因为这会让暂停我们的线程感到惊讶。</span>
          _recursions <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
          _succ <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
          <span class="token function">exit</span> <span class="token punctuation">(</span>false<span class="token punctuation">,</span> Self<span class="token punctuation">)</span> <span class="token punctuation">;</span>  
          jt<span class="token operator">-&gt;</span><span class="token function">java_suspend_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Self<span class="token operator">-&gt;</span><span class="token function">set_current_pending_monitor</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    
      Atomic<span class="token operator">::</span><span class="token function">dec_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>_count <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      Self<span class="token operator">-&gt;</span>_Stalled <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    
      <span class="token comment">// Must either set _recursions = 0 or ASSERT _recursions == 0.</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span>     <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Self       <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>_succ  <span class="token operator">!=</span> Self       <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oop<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> markOopDesc<span class="token operator">::</span><span class="token function">encode</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    
      <span class="token comment">// 线程——现在是所有者——又回到了 vm 模式。</span>
      <span class="token comment">// 通过 TI、DTrace 和 jvmstat 报告这一喜讯。探测效应是不平凡的。</span>
      <span class="token comment">// 所有的报道都是在我们拿着显示器的时候发生的，增加了关键部分的长度。 Amdahl 的并行加速定律生动地发挥了作用。</span>
      <span class="token comment">//</span>
      <span class="token comment">// 另一种选择可能是聚合事件（线程本地或每个监视器聚合）并将报告推迟到更合适的时间 - </span>
      <span class="token comment">// 例如下一次某个线程遇到争用但尚未获得锁。虽然旋转该线程可以旋转，但我们可以增加 JVMStat 计数器等。</span>
    
      <span class="token function">DTRACE_MONITOR_PROBE</span><span class="token punctuation">(</span>contended__entered<span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>JvmtiExport<span class="token operator">::</span><span class="token function">should_post_monitor_contended_entered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        JvmtiExport<span class="token operator">::</span><span class="token function">post_monitor_contended_entered</span><span class="token punctuation">(</span>jt<span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">should_commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">set_klass</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oop<span class="token punctuation">)</span>this<span class="token operator">-&gt;</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span><span class="token function">set_previousOwner</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TYPE_JAVALANGTHREAD<span class="token punctuation">)</span>_previous_owner_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span><span class="token function">set_address</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TYPE_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>this<span class="token operator">-&gt;</span><span class="token function">object_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ObjectMonitor<span class="token operator">::</span>_sync_ContendedLockAttempts <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         ObjectMonitor<span class="token operator">::</span>_sync_ContendedLockAttempts<span class="token operator">-&gt;</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>底层方法流程：</li></ul><p><img src="/assets/img.22e5403d.png" alt="img.png"></p><hr><h2 id="_3-锁优化" tabindex="-1"><a class="header-anchor" href="#_3-锁优化" aria-hidden="true">#</a> 3. 锁优化</h2><blockquote><p>JDK 6 进行锁的优化</p></blockquote><h3 id="锁升级流程" tabindex="-1"><a class="header-anchor" href="#锁升级流程" aria-hidden="true">#</a> 锁升级流程</h3><div class="md-enhance-mermaid loading"><svg xmlns="http://www.w3.org/2000/svg" class="icon loading-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="loading icon"><circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" strokewidth="2"><animate attributename="r" repeatcount="indefinite" dur="1s" values="0;40" keytimes="0;1" keysplines="0 0.2 0.8 1" calcmode="spline" begin="0s"></animate><animate attributename="opacity" repeatcount="indefinite" dur="1s" values="1;0" keytimes="0;1" keysplines="0.2 0 0.8 1" calcmode="spline" begin="0s"></animate></circle><circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" strokewidth="2"><animate attributename="r" repeatcount="indefinite" dur="1s" values="0;40" keytimes="0;1" keysplines="0 0.2 0.8 1" calcmode="spline" begin="-0.333s"></animate><animate attributename="opacity" repeatcount="indefinite" dur="1s" values="1;0" keytimes="0;1" keysplines="0.2 0 0.8 1" calcmode="spline" begin="-0.333s"></animate></circle><circle cx="50" cy="50" r="0" fill="none" stroke="currentColor" strokewidth="2"><animate attributename="r" repeatcount="indefinite" dur="1s" values="0;40" keytimes="0;1" keysplines="0 0.2 0.8 1" calcmode="spline" begin="-0.667s"></animate><animate attributename="opacity" repeatcount="indefinite" dur="1s" values="1;0" keytimes="0;1" keysplines="0.2 0 0.8 1" calcmode="spline" begin="-0.667s"></animate></circle></svg></div><h3 id="_1-偏向锁" tabindex="-1"><a class="header-anchor" href="#_1-偏向锁" aria-hidden="true">#</a> 1) 偏向锁</h3><ul><li>当线程访问同步块获取锁时，会在对象头和栈帧中的锁记录里存储偏向锁的线程ID，之后这个线程再次进入同步块时都不需要CAS来加锁和解锁了，</li><li>偏向锁会永远偏向第一个获得锁的线程，</li><li>如果后续没有其他线程获得过这个锁，持有锁的线程就永远不需要进行同步，反之，当有其他线程竞争偏向锁时，持有偏向锁的线程就会释放偏向锁</li></ul><ol><li><strong>参数</strong></li></ol><ul><li><code>xx:UseBiasedLocking = true</code></li><li>JDK 1.5 关闭</li><li>JDK 1.6 默认开启</li><li>JDK 15 关闭废弃</li></ul><ol start="2"><li><strong>适用场景</strong></li></ol><ul><li>连续多次是同一个线程申请相同的锁</li><li>不适用于锁竞争激烈的场景</li></ul><ol start="3"><li><strong>对象头</strong></li></ol><table><thead><tr><th>场景</th><th>对象头</th></tr></thead><tbody><tr><td>偏向锁还未偏向任何线程</td><td>hashCode + 分代年龄 + 偏向标志位 <code>1</code> + 锁标志位 <code>01</code></td></tr><tr><td>偏向锁设置偏向某个线程</td><td>线程 id + Epoch + 分代年龄 + 偏向标志位 <code>1</code> + 锁标志位 <code>01</code></td></tr></tbody></table><ol start="4"><li>源码 <a href="https://github.com/openjdk/jdk/blob/jdk8-b120/hotspot/src/share/vm/runtime/synchronizer.cpp" target="_blank" rel="noopener noreferrer">地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ol><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> ObjectSynchronizer<span class="token operator">::</span><span class="token function">fast_enter</span><span class="token punctuation">(</span>Handle obj<span class="token punctuation">,</span> BasicLock<span class="token operator">*</span> lock<span class="token punctuation">,</span> bool attempt_rebias<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 使用了 偏向锁</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>UseBiasedLocking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不在 安全点，尝试偏向当前线程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SafepointSynchronize<span class="token operator">::</span><span class="token function">is_at_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      BiasedLocking<span class="token operator">::</span>Condition cond <span class="token operator">=</span> BiasedLocking<span class="token operator">::</span><span class="token function">revoke_and_rebias</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> attempt_rebias<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cond <span class="token operator">==</span> BiasedLocking<span class="token operator">::</span>BIAS_REVOKED_AND_REBIASED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 成功，返回</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>attempt_rebias<span class="token punctuation">,</span> <span class="token string">&quot;can not rebias toward VM thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      BiasedLocking<span class="token operator">::</span><span class="token function">revoke_at_safepoint</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token operator">-&gt;</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">has_bias_pattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;biases should be revoked by now&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 不允许使用偏向锁 | 获偏向锁失败，进入 slow_enter 方法，进入轻量级状态</span>
 <span class="token function">slow_enter</span> <span class="token punctuation">(</span>obj<span class="token punctuation">,</span> lock<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-轻量级锁" tabindex="-1"><a class="header-anchor" href="#_2-轻量级锁" aria-hidden="true">#</a> 2) 轻量级锁</h3><ol><li><strong>适用场景</strong></li></ol><ul><li>竞争 锁对象 的线程不多 &amp; 线程持有锁的时间也不长</li><li>此时，自旋的消耗比内核态 - 用户态的切换开销小，时间短对 CPU 友好</li></ul><ol start="2"><li><strong>对象头</strong></li></ol><table><thead><tr><th>场景</th><th>对象头</th></tr></thead><tbody><tr><td>轻量级锁</td><td>指向 <code>Record Lock</code> 的指针 + 锁标志位 <code>00</code></td></tr><tr><td>重量级锁</td><td>指向 <strong>重量级锁</strong> 的指针 + 锁标志位 <code>01</code></td></tr></tbody></table><ol start="3"><li>原理</li></ol><ul><li>在当前线程的栈帧中建立 <code>Record Lock</code> 作为 锁对象头 <code>Mark Word</code> 的副本</li><li><code>CAS</code> 将 锁对象的 <code>Mark Word</code> 更新为指向 <code>Record Lock</code> 的地址</li><li>若成功，修改对象头的锁标志位为 <code>00</code>，表示对象处于轻量级锁状态，线程获取了这个对象的锁，执行相关操作，执行完同步操作后，将 <code>Mark Word</code> 指针复位</li><li>若失败，说明有其他线程在和当前线程竞争该对象的锁，此时尝试<strong>自旋</strong>等待其他线程释放锁，若自旋一定次数后仍未获得锁，则升级为<strong>重量级锁</strong></li></ul><ol start="4"><li>源码</li></ol><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 不允许使用偏向锁 | 获偏向锁失败，进入该方法</span>
<span class="token keyword">void</span> ObjectSynchronizer<span class="token operator">::</span><span class="token function">slow_enter</span><span class="token punctuation">(</span>Handle obj<span class="token punctuation">,</span> BasicLock<span class="token operator">*</span> lock<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  markOop mark <span class="token operator">=</span> obj<span class="token operator">-&gt;</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 对象的对象头</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>mark<span class="token operator">-&gt;</span><span class="token function">has_bias_pattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;should not see bias pattern here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mark<span class="token operator">-&gt;</span><span class="token function">is_neutral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 未被其他线程获取</span>
    <span class="token comment">// 创建副本</span>
    lock<span class="token operator">-&gt;</span><span class="token function">set_displaced_header</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// CAS 尝试更新 锁对象的对象头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mark <span class="token operator">==</span> <span class="token punctuation">(</span>markOop<span class="token punctuation">)</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">mark_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mark<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">TEVENT</span> <span class="token punctuation">(</span>slow_enter<span class="token operator">:</span> release stacklock<span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">;</span> <span class="token comment">// 成功，返回</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Fall through to inflate() ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span>
  <span class="token comment">// 存在并发竞争</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mark<span class="token operator">-&gt;</span><span class="token function">has_locker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> THREAD<span class="token operator">-&gt;</span><span class="token function">is_lock_owned</span><span class="token punctuation">(</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>mark<span class="token operator">-&gt;</span><span class="token function">locker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>lock <span class="token operator">!=</span> mark<span class="token operator">-&gt;</span><span class="token function">locker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;must not re-lock the same lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>lock <span class="token operator">!=</span> <span class="token punctuation">(</span>BasicLock<span class="token operator">*</span><span class="token punctuation">)</span>obj<span class="token operator">-&gt;</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;don&#39;t relock with same BasicLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token operator">-&gt;</span><span class="token function">set_displaced_header</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
  <span class="token comment">// 重置 lock.set_displaced_header</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mark<span class="token operator">-&gt;</span><span class="token function">has_monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mark<span class="token operator">-&gt;</span><span class="token function">monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">is_entered</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token operator">-&gt;</span><span class="token function">set_displaced_header</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  lock<span class="token operator">-&gt;</span><span class="token function">set_displaced_header</span><span class="token punctuation">(</span>markOopDesc<span class="token operator">::</span><span class="token function">unused_mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 升级为 重量级锁</span>
  ObjectSynchronizer<span class="token operator">::</span><span class="token function">inflate</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> <span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">enter</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>自旋</p></blockquote><ul><li>自旋锁： <ul><li>JDK 1.4.2 引入自旋锁，默认关闭</li><li>JDK 1.6 自旋锁默认开启， <code>-XX:+UseSpinning</code> 开启， <code>+XX:PreBlockSpin = 10</code> [default = 10]</li><li>自适应自旋锁，由 <code>JVM</code> 进行控制，取决于： <ul><li>当前线程上一次获得该锁的自旋时间</li><li>当前锁的拥有者状态</li></ul></li></ul></li></ul><h3 id="_3-锁消除" tabindex="-1"><a class="header-anchor" href="#_3-锁消除" aria-hidden="true">#</a> 3) 锁消除</h3><ul><li>虚拟机即时编译器在运行时检测到某段需要同步的代码不可能存在共享数据竞争，因此对锁进行消除</li><li>主要判定依据：<strong>逃逸分析</strong></li></ul><h3 id="_4-锁粗化" tabindex="-1"><a class="header-anchor" href="#_4-锁粗化" aria-hidden="true">#</a> 4) 锁粗化</h3><ul><li>一系列的连续操作都是对同一对象进行反复加锁 &amp; 解锁操作，此时可以将加锁同步的范围扩展</li></ul><hr><h2 id="_4-特点" tabindex="-1"><a class="header-anchor" href="#_4-特点" aria-hidden="true">#</a> 4. 特点</h2><h3 id="_1-有序性" tabindex="-1"><a class="header-anchor" href="#_1-有序性" aria-hidden="true">#</a> 1) 有序性</h3><ul><li>保证多线程任意时刻只能有一个线程获取锁对象，相当于单线程执行，而由于单线程的 as-if-serial 原则，保证了有序性</li></ul><h3 id="_2-可见性" tabindex="-1"><a class="header-anchor" href="#_2-可见性" aria-hidden="true">#</a> 2) 可见性</h3><ul><li>加锁之前将工作内存的变量值失效，从主存中读取，释放锁之前，将工作内存的变量刷回主存，从而保证了可见性</li></ul><h3 id="_3-原子性" tabindex="-1"><a class="header-anchor" href="#_3-原子性" aria-hidden="true">#</a> 3) 原子性</h3><ul><li>同一时刻单线程执行保证原子性</li></ul><h3 id="_4-可重入性" tabindex="-1"><a class="header-anchor" href="#_4-可重入性" aria-hidden="true">#</a> 4) 可重入性</h3><ul><li>为可重入锁，有效避免死锁的情况，可同一线程多次获得同一个对象锁</li></ul><h3 id="_5-独占性" tabindex="-1"><a class="header-anchor" href="#_5-独占性" aria-hidden="true">#</a> 5) 独占性</h3><ul><li>为独占锁，任意时刻最多一个线程占用</li></ul><h3 id="_6-不可中断性" tabindex="-1"><a class="header-anchor" href="#_6-不可中断性" aria-hidden="true">#</a> 6) 不可中断性</h3><ul><li>一个线程获取到锁对象后，其余想要获取该锁的线程只能进入等待 / 阻塞状态，不可被中断</li></ul><h3 id="_7-非公平锁" tabindex="-1"><a class="header-anchor" href="#_7-非公平锁" aria-hidden="true">#</a> 7) 非公平锁</h3><ul><li>当锁被某个线程释放，其余线程可以获取锁时，其余线程共同竞争，而不是按照先后顺序获取</li></ul><h3 id="_8-自动释放锁" tabindex="-1"><a class="header-anchor" href="#_8-自动释放锁" aria-hidden="true">#</a> 8) 自动释放锁</h3><ul><li>当线程不需要锁对象时，自动释放，无需手动释放</li></ul></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/10/10 下午8:43:48</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: liuxianzhishou@qq.com">liuxianzhishou</span><!--]--><!--]--></div></footer><nav class="page-nav"><!----><a href="/java/concurrency/volatile.html" class="nav-link next" aria-label="🟠 volatile"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">🟠 volatile<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----><!--]--></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app.5aebcaaa.js" defer></script>
  </body>
</html>
