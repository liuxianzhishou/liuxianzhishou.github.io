import{_ as r}from"./plugin-vue_export-helper.21dcd24c.js";import{r as u,o as d,c as m,a as n,b as c,w as a,d as s,e as i}from"./app.5aebcaaa.js";const v={},b=n("h1",{id:"server",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#server","aria-hidden":"true"},"#"),s(" \u{1F339} Server")],-1),f={href:"https://github.com/redis/redis/blob/7.0/src/server.c",target:"_blank",rel:"noopener noreferrer"},_=s("\u6E90\u7801\u5730\u5740"),y=i(`<div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">initServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u521D\u59CB\u5316 Server \u914D\u7F6E</span>
    <span class="token comment">// ...</span>
    <span class="token function">initServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u521D\u59CB\u5316 Server</span>
    <span class="token comment">// ...</span>
    <span class="token function">InitServerLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Server \u521D\u59CB\u5316\u7684\u540E\u7F6E\u5904\u7406</span>
    <span class="token comment">// ...</span>
    <span class="token function">aeMain</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u542F\u52A8\u4E8B\u4EF6\u5FAA\u73AF</span>
    <span class="token function">aeDeleteEventLoop</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// \u5220\u9664\u4E8B\u4EF6\u5FAA\u73AF</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),E=i('<h2 id="_1-server-\u521D\u59CB\u5316" tabindex="-1"><a class="header-anchor" href="#_1-server-\u521D\u59CB\u5316" aria-hidden="true">#</a> 1. Server \u521D\u59CB\u5316</h2><h3 id="_1-\u521D\u59CB\u5316-server-\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#_1-\u521D\u59CB\u5316-server-\u914D\u7F6E" aria-hidden="true">#</a> 1) \u521D\u59CB\u5316 Server \u914D\u7F6E</h3><ul><li><code>populateCommandTable</code><ul><li>\u521D\u59CB\u5316\u547D\u4EE4\u8868</li></ul></li></ul><h3 id="_2-\u521D\u59CB\u5316-server" tabindex="-1"><a class="header-anchor" href="#_2-\u521D\u59CB\u5316-server" aria-hidden="true">#</a> 2) \u521D\u59CB\u5316 Server</h3><ol><li><strong>Server \u76F8\u5173\u53C2\u6570\u521D\u59CB\u5316</strong></li><li><strong>aeCreateEventLoop</strong><ul><li>\u521B\u5EFA \u4E8B\u4EF6\u5FAA\u73AF\u673A\u5236</li></ul></li><li><strong>listenToPort</strong> &amp; <strong>anetUnixServer</strong><ul><li>\u5F00\u542F (<code>TCP</code> | <code>TLS</code>) &amp; <code>Unix</code> socket \u76D1\u542C</li></ul></li><li><strong>aeCreateTimeEvent</strong><ul><li>\u5411\u4E8B\u4EF6\u5FAA\u73AF\u4E2D\u6CE8\u518C timer \u56DE\u8C03\uFF0C\u6267\u884C <code>serverCron</code> \u51FD\u6570\uFF0C\u4E3B\u7EBF\u7A0B\u6267\u884C</li></ul></li><li><strong>aeCreateFileEvent</strong><ul><li>\u6CE8\u518C (<code>TCP</code> | <code>TLS</code>) &amp; <code>Unix</code> &amp; <code>module pipe</code> \u7684 IO \u4E8B\u4EF6\u56DE\u8C03</li></ul></li><li><strong>\u5176\u4ED6\u521D\u59CB\u5316\u64CD\u4F5C</strong>\uFF0C <ul><li>\u4F8B\u5982 \u96C6\u7FA4\u521D\u59CB\u5316</li></ul></li></ol><h3 id="_3-server-\u521D\u59CB\u5316\u7684\u540E\u7F6E\u5904\u7406" tabindex="-1"><a class="header-anchor" href="#_3-server-\u521D\u59CB\u5316\u7684\u540E\u7F6E\u5904\u7406" aria-hidden="true">#</a> 3) Server \u521D\u59CB\u5316\u7684\u540E\u7F6E\u5904\u7406</h3><ul><li><strong>bioInit</strong><ul><li>\u521D\u59CB\u5316\u540E\u53F0\u7EBF\u7A0B\uFF0C\u521B\u5EFA\u7EBF\u7A0B\u6267\u884C \u5F02\u6B65\u4EFB\u52A1</li><li>\u4F8B\uFF1AAOF fsync \u5237\u76D8\uFF0ClazyFree \u7B49</li></ul></li></ul><h3 id="\u6E90\u7801" tabindex="-1"><a class="header-anchor" href="#\u6E90\u7801" aria-hidden="true">#</a> \u6E90\u7801</h3>',8),w=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u521D\u59CB\u5316 Server \u914D\u7F6E"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"initServerConfig"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("default_bindaddr"),n("span",{class:"token punctuation"},"["),s("CONFIG_DEFAULT_BINDADDR_COUNT"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" CONFIG_DEFAULT_BINDADDR"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"initConfigValues"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"updateCachedTime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"getRandomHexChars"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("runid"),n("span",{class:"token punctuation"},","),s("CONFIG_RUN_ID_SIZE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("runid"),n("span",{class:"token punctuation"},"["),s("CONFIG_RUN_ID_SIZE"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token char"},"'\\0'"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"changeReplicationId"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"clearReplicationId2"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// \u521D\u59CB\u5316 server \u7684\u5404\u79CD\u53C2\u6570\uFF0C\u5305\u542B \u4E3B\u4ECE\u590D\u5236\u3001\u6545\u969C\u8F6C\u79FB\u3001\u5BA2\u6237\u7AEF\u8F93\u51FA\u7F13\u51B2\u533A\u3001Linux OOM \u5206\u6570\u914D\u7F6E\u7B49"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("hz "),n("span",{class:"token operator"},"="),s(" CONFIG_DEFAULT_HZ"),n("span",{class:"token punctuation"},";"),s(` 
    server`),n("span",{class:"token punctuation"},"."),s("timezone "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getTimeZone"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Initialized by tzset(). */"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"int"),s(" lruclock "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getLRUClock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"atomicSet"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("lruclock"),n("span",{class:"token punctuation"},","),s("lruclock"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"resetServerSaveParams"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"appendServerSaveParams"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"60"),n("span",{class:"token operator"},"*"),n("span",{class:"token number"},"60"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s("  "),n("span",{class:"token comment"},"// \u5728 1 \u5C0F\u65F6\u548C 1 \u6B21\u66F4\u6539\u540E\u4FDD\u5B58"),s(`
    `),n("span",{class:"token function"},"appendServerSaveParams"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"300"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s("  "),n("span",{class:"token comment"},"// \u5728 5 \u5206\u949F\u548C 100 \u6B21\u66F4\u6539\u540E\u4FDD\u5B58"),s(`
    `),n("span",{class:"token function"},"appendServerSaveParams"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"60"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"10000"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5728 1 \u5206\u949F\u548C 10000 \u6B21\u66F4\u6539\u540E\u4FDD\u5B58"),s(`

    `),n("span",{class:"token comment"},"/* \u53CC\u5E38\u91CF\u521D\u59CB\u5316n */"),s(`
    R_Zero `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0.0"),n("span",{class:"token punctuation"},";"),s(`
    R_PosInf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1.0"),n("span",{class:"token operator"},"/"),s("R_Zero"),n("span",{class:"token punctuation"},";"),s(`
    R_NegInf `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1.0"),n("span",{class:"token operator"},"/"),s("R_Zero"),n("span",{class:"token punctuation"},";"),s(`
    R_Nan `),n("span",{class:"token operator"},"="),s(" R_Zero"),n("span",{class:"token operator"},"/"),s("R_Zero"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"/* \u547D\u4EE4\u8868\u7684\u521D\u59CB\u5316\uFF0C\u56E0\u4E3A\u5B83\u662F\u521D\u59CB\u914D\u7F6E\u7684\u4E00\u90E8\u5206\uFF0C\u547D\u4EE4\u540D\u79F0\u53EF\u4EE5\u901A\u8FC7 redis.conf \u4F7F\u7528 rename-command \u6307\u4EE4\u8FDB\u884C\u66F4\u6539\u3002 */"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("commands "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dictCreate"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("commandTableDictType"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("orig_commands "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dictCreate"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("commandTableDictType"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"populateCommandTable"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"/* \u4ECE commands.c \u4E2D\u7684\u9759\u6001\u8868\u586B\u5145 Redis \u547D\u4EE4\u8868\u5B57\u5178\uFF0C\u8BE5\u9759\u6001\u8868\u662F\u4ECE\u547D\u4EE4\u6587\u4EF6\u5939\u4E2D\u7684 json \u6587\u4EF6\u81EA\u52A8\u751F\u6210\u7684\u3002 */"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"populateCommandTable"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"redisCommand"),s(),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},";"),s(`

  `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    c `),n("span",{class:"token operator"},"="),s(" redisCommandTable "),n("span",{class:"token operator"},"+"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("declared_name "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`

       `),n("span",{class:"token keyword"},"int"),s(" retval1"),n("span",{class:"token punctuation"},","),s(" retval2"),n("span",{class:"token punctuation"},";"),s(`

       c`),n("span",{class:"token operator"},"->"),s("fullname "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"sdsnew"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("declared_name"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
       `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"populateCommandStructure"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(`
           `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`

       retval1 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dictAdd"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("commands"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"sdsdup"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("fullname"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
       `),n("span",{class:"token comment"},"// \u586B\u5145\u4E00\u4E2A\u4E0D\u53D7 redis.conf \u4E2D rename-command \u8BED\u53E5\u5F71\u54CD\u7684\u9644\u52A0\u5B57\u5178\u3002"),s(`
       retval2 `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dictAdd"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("orig_commands"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"sdsdup"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("fullname"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
       `),n("span",{class:"token function"},"serverAssert"),n("span",{class:"token punctuation"},"("),s("retval1 "),n("span",{class:"token operator"},"=="),s(" DICT_OK "),n("span",{class:"token operator"},"&&"),s(" retval2 "),n("span",{class:"token operator"},"=="),s(" DICT_OK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),A=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u521D\u59CB\u5316 Server"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"initServer"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGHUP"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"signal"),n("span",{class:"token punctuation"},"("),s("SIGPIPE"),n("span",{class:"token punctuation"},","),s(" SIG_IGN"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"setupSignalHandlers"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"makeThreadKillable"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("syslog_enabled"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"openlog"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("syslog_ident"),n("span",{class:"token punctuation"},","),s(" LOG_PID "),n("span",{class:"token operator"},"|"),s(" LOG_NDELAY "),n("span",{class:"token operator"},"|"),s(" LOG_NOWAIT"),n("span",{class:"token punctuation"},","),s(`
            server`),n("span",{class:"token punctuation"},"."),s("syslog_facility"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// 1. \u4ECE\u914D\u7F6E\u7CFB\u7EDF\u8BBE\u7F6E\u9ED8\u8BA4\u503C\u540E\u521D\u59CB\u5316\u3002"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("aof_state "),n("span",{class:"token operator"},"="),s(" server"),n("span",{class:"token punctuation"},"."),s("aof_enabled "),n("span",{class:"token operator"},"?"),s(" AOF_ON "),n("span",{class:"token operator"},":"),s(" AOF_OFF"),n("span",{class:"token punctuation"},";"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("hz "),n("span",{class:"token operator"},"="),s(" server"),n("span",{class:"token punctuation"},"."),s("config_hz"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token comment"},"// 2. \u521B\u5EFA \u4E8B\u4EF6\u5FAA\u73AF"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("el "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"aeCreateEventLoop"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("maxclients"),n("span",{class:"token operator"},"+"),s("CONFIG_FDSET_INCR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("el "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(`
                  `),n("span",{class:"token string"},`"Failed creating the event loop. Error message: '%s'"`),n("span",{class:"token punctuation"},","),s(`
                  `),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("db "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zmalloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("redisDb"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"*"),s("server"),n("span",{class:"token punctuation"},"."),s("dbnum"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// 3. \u4E3A\u7528\u6237\u547D\u4EE4\u6253\u5F00 TCP | TLS \u4FA6\u542C\u5957\u63A5\u5B57\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("port "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"listenToPort"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("port"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("server"),n("span",{class:"token punctuation"},"."),s("ipfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Failed listening on port %u (TCP), aborting."'),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("port"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("tls_port "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"listenToPort"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("tls_port"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("server"),n("span",{class:"token punctuation"},"."),s("tlsfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Failed listening on port %u (TLS), aborting."'),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("tls_port"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token comment"},"// \u6253\u5F00\u4FA6\u542C\u7684 Unix \u5957\u63A5\u5B57\uFF1A\u4E00\u79CD\u9AD8\u6548\u7684\u8FDB\u7A0B\u95F4\u901A\u4FE1\u673A\u5236\uFF0C\u6BD4 TCP \u534F\u8BAE\u6027\u80FD\u66F4\u597D\uFF0C\u7701\u53BB\u4E86\u534F\u8BAE\u6808\u7684\u5F00\u9500"),s(`
    `),n("span",{class:"token comment"},"// \u5F53 Redis Client \u8FDE\u63A5\u540C\u4E00\u53F0\u673A\u5668\u4E0A\u662F Redis \u670D\u52A1\u5668\u65F6\uFF0C\u53EF\u4EE5\u9009\u62E9\u4F7F\u7528 Unix domain socket \u8FDE\u63A5"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("unixsocket "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"unlink"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("unixsocket"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(` 
        server`),n("span",{class:"token punctuation"},"."),s("sofd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetUnixServer"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},","),s(`
                                     server`),n("span",{class:"token punctuation"},"."),s("unixsocket"),n("span",{class:"token punctuation"},","),s(`
                                     `),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"mode_t"),n("span",{class:"token punctuation"},")"),s("server"),n("span",{class:"token punctuation"},"."),s("unixsocketperm"),n("span",{class:"token punctuation"},","),s(` 
                                     server`),n("span",{class:"token punctuation"},"."),s("tcp_backlog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("sofd "),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Failed opening Unix socket: %s"'),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token function"},"anetNonBlock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s("server"),n("span",{class:"token punctuation"},"."),s("sofd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"anetCloexec"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("sofd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token comment"},"// \u5982\u679C\u6839\u672C\u6CA1\u6709\u4FA6\u542C\u5957\u63A5\u5B57\uFF0C\u5219\u4E2D\u6B62\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("ipfd"),n("span",{class:"token punctuation"},"."),s("count "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" server"),n("span",{class:"token punctuation"},"."),s("tlsfd"),n("span",{class:"token punctuation"},"."),s("count "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(" server"),n("span",{class:"token punctuation"},"."),s("sofd "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Configured to not listen anywhere, exiting."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// server \u76F8\u5173\u53C2\u6570\u521D\u59CB\u5316"),s(`
    `),n("span",{class:"token function"},"evictionPoolAlloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Initialize the LRU keys pool. */"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("pubsub_channels "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"dictCreate"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("keylistDictType"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token comment"},"// 4. \u521B\u5EFA\u8BA1\u65F6\u5668\u56DE\u8C03\uFF0C\u8FD9\u662F\u6211\u4EEC\u589E\u91CF\u5904\u7406\u8BB8\u591A\u540E\u53F0\u64CD\u4F5C\u7684\u65B9\u5F0F\uFF0C\u4F8B\u5982\u5BA2\u6237\u7AEF\u8D85\u65F6\u3001\u672A\u8BBF\u95EE\u7684\u8FC7\u671F\u952E\u7684\u9A71\u9010\u7B49\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"aeCreateTimeEvent"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("el"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" serverCron"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" AE_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverPanic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},`"Can't create event loop timers."`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// 5. \u6CE8\u518C (TCP | TLS) & Unix & module pipe \u7684 IO \u4E8B\u4EF6\u56DE\u8C03\uFF0C\u542F\u52A8 \u8FDE\u63A5\u5E94\u7B54\u5904\u7406\u5668"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"createSocketAcceptHandler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("server"),n("span",{class:"token punctuation"},"."),s("ipfd"),n("span",{class:"token punctuation"},","),s(" acceptTcpHandler"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(" C_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverPanic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Unrecoverable error creating TCP socket accept handler."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"createSocketAcceptHandler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("server"),n("span",{class:"token punctuation"},"."),s("tlsfd"),n("span",{class:"token punctuation"},","),s(" acceptTLSHandler"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(" C_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverPanic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Unrecoverable error creating TLS socket accept handler."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("sofd "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"aeCreateFileEvent"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("el"),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("sofd"),n("span",{class:"token punctuation"},","),s(" AE_READABLE"),n("span",{class:"token punctuation"},","),s(" acceptUnixHandler"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" AE_ERR"),n("span",{class:"token punctuation"},")"),s(` 
        `),n("span",{class:"token function"},"serverPanic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Unrecoverable error creating server.sofd file event."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"aeCreateFileEvent"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("el"),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("module_pipe"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" AE_READABLE"),n("span",{class:"token punctuation"},","),s(" modulePipeReadable"),n("span",{class:"token punctuation"},","),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" AE_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverPanic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Error registering the readable event for the module pipe."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// \u5728\u7761\u7720\u5904\u7406\u7A0B\u5E8F\u4E4B\u524D\u548C\u4E4B\u540E\u6CE8\u518C\uFF08\u6CE8\u610F\u8FD9\u9700\u8981\u5728\u52A0\u8F7D\u6301\u4E45\u6027\u4E4B\u524D\u5B8C\u6210\uFF0C\u56E0\u4E3A\u5B83\u88AB processEventsWhileBlocked \u4F7F\u7528\u3002"),s(`
    `),n("span",{class:"token function"},"aeSetBeforeSleepProc"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("el"),n("span",{class:"token punctuation"},","),s("beforeSleep"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"aeSetAfterSleepProc"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("el"),n("span",{class:"token punctuation"},","),s("afterSleep"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// 32 \u4F4D\u5B9E\u4F8B\u88AB\u9650\u5236\u4E3A 4GB \u7684\u5730\u5740\u7A7A\u95F4\uFF0C\u56E0\u6B64\u5982\u679C\u7528\u6237\u63D0\u4F9B\u7684\u914D\u7F6E\u4E2D\u6CA1\u6709\u660E\u786E\u7684\u9650\u5236\uFF0C"),s(`
    `),n("span",{class:"token comment"},"// \u9ED8\u8BA4 maxmemory = 3GB\uFF0C\u6DD8\u6C70\u7B56\u7565\u4E3A noeviction\uFF0C\u907F\u514D Redis \u5B9E\u4F8B\u56E0\u5185\u5B58\u4E0D\u8DB3\u800C\u5BFC\u81F4\u7684\u65E0\u7528\u5D29\u6E83\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("arch_bits "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"32"),s(),n("span",{class:"token operator"},"&&"),s(" server"),n("span",{class:"token punctuation"},"."),s("maxmemory "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},`"Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with 'noeviction' policy now."`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        server`),n("span",{class:"token punctuation"},"."),s("maxmemory "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"3072LL"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1024"),n("span",{class:"token operator"},"*"),n("span",{class:"token number"},"1024"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* 3 GB */"),s(`
        server`),n("span",{class:"token punctuation"},"."),s("maxmemory_policy "),n("span",{class:"token operator"},"="),s(" MAXMEMORY_NO_EVICTION"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// 6. \u96C6\u7FA4\u521D\u59CB\u5316"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("cluster_enabled"),n("span",{class:"token punctuation"},")"),s(` 
        `),n("span",{class:"token function"},"clusterInit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"scriptingInit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"functionsInit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"slowlogInit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"latencyMonitorInit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u521D\u59CB\u5316 ACL \u9ED8\u8BA4\u5BC6\u7801\uFF08\u5982\u679C\u5B58\u5728\uFF09"),s(`
    `),n("span",{class:"token function"},"ACLUpdateDefaultUserPassword"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("requirepass"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"applyWatchdogPeriod"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},`/* 
 * \u521D\u59CB\u5316\u4E00\u7EC4\u6587\u4EF6\u63CF\u8FF0\u7B26\u4EE5\u4FA6\u542C\u7ED1\u5B9A\u5728 Redis \u670D\u52A1\u5668\u914D\u7F6E\u4E2D\u6307\u5B9A\u7684\u5730\u5740\u7684\u6307\u5B9A\u201C\u7AEF\u53E3\u201D\u3002
 * \u76D1\u542C\u6587\u4EF6\u63CF\u8FF0\u7B26\u5B58\u50A8\u5728\u6574\u6570\u6570\u7EC4\u201Cfds\u201D\u4E2D\uFF0C\u5B83\u4EEC\u7684\u6570\u91CF\u8BBE\u7F6E\u5728\u201Ccount\u201D\u4E2D\u3002
 *
 * \u8981\u7ED1\u5B9A\u7684\u5730\u5740\u5728\u5168\u5C40 server.bindaddr \u6570\u7EC4\u4E2D\u6307\u5B9A\uFF0C\u5B83\u4EEC\u7684\u7F16\u53F7\u662F server.bindaddr_count\u3002
 * \u5982\u679C\u670D\u52A1\u5668\u914D\u7F6E\u4E0D\u5305\u542B\u8981\u7ED1\u5B9A\u7684\u7279\u5B9A\u5730\u5740\uFF0C\u6B64\u51FD\u6570\u5C06\u5C1D\u8BD5\u4E3A IPv4 \u548C IPv6 \u534F\u8BAE\u7ED1\u5B9A\uFF08\u6240\u6709\u5730\u5740\uFF09
 *
 * \u6210\u529F\u65F6\uFF0C\u51FD\u6570\u8FD4\u56DE C_OK\u3002
 * \u51FA\u9519\u65F6\uFF0C\u51FD\u6570\u8FD4\u56DE C_ERR\u3002
 * \u8981\u4F7F\u51FD\u6570\u51FA\u9519\uFF0C\u81F3\u5C11\u65E0\u6CD5\u7ED1\u5B9A server.bindaddr \u5730\u5740\u4E4B\u4E00\uFF0C\u6216\u8005\u5728\u670D\u52A1\u5668\u914D\u7F6E\u4E2D\u672A\u6307\u5B9A\u7ED1\u5B9A\u5730\u5740\uFF0C\u4F46\u51FD\u6570\u65E0\u6CD5\u7ED1\u5B9A IPv4 \u6216 IPv6 \u534F\u8BAE\u4E2D\u7684\u81F3\u5C11\u4E00\u4E2A.
 */`),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"listenToPort"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" port"),n("span",{class:"token punctuation"},","),s(" socketFds "),n("span",{class:"token operator"},"*"),s("sfd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token operator"},"*"),s("bindaddr "),n("span",{class:"token operator"},"="),s(" server"),n("span",{class:"token punctuation"},"."),s("bindaddr"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("bindaddr_count "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5982\u679C\u6211\u4EEC\u6CA1\u6709\u7ED1\u5B9A\u5730\u5740\uFF0C\u6211\u4EEC\u5C31\u4E0D\u4F1A\u76D1\u542C TCP \u5957\u63A5\u5B57"),s(`

    `),n("span",{class:"token comment"},"// \u904D\u5386\u9700\u8981\u76D1\u542C\u7684\u7AEF\u53E3\u96C6\u5408"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" server"),n("span",{class:"token punctuation"},"."),s("bindaddr_count"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"char"),n("span",{class:"token operator"},"*"),s(" addr "),n("span",{class:"token operator"},"="),s(" bindaddr"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"int"),s(" optional "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"*"),s("addr "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'-'"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("optional"),n("span",{class:"token punctuation"},")"),s(" addr"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strchr"),n("span",{class:"token punctuation"},"("),s("addr"),n("span",{class:"token punctuation"},","),n("span",{class:"token char"},"':'"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token comment"},"// \u7ED1\u5B9A IPv6"),s(`
            sfd`),n("span",{class:"token operator"},"->"),s("fd"),n("span",{class:"token punctuation"},"["),s("sfd"),n("span",{class:"token operator"},"->"),s("count"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetTcp6Server"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},","),s("port"),n("span",{class:"token punctuation"},","),s("addr"),n("span",{class:"token punctuation"},","),s("server"),n("span",{class:"token punctuation"},"."),s("tcp_backlog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token comment"},"// \u7ED1\u5B9A IPv4"),s(`
            sfd`),n("span",{class:"token operator"},"->"),s("fd"),n("span",{class:"token punctuation"},"["),s("sfd"),n("span",{class:"token operator"},"->"),s("count"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetTcpServer"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},","),s("port"),n("span",{class:"token punctuation"},","),s("addr"),n("span",{class:"token punctuation"},","),s("server"),n("span",{class:"token punctuation"},"."),s("tcp_backlog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token comment"},"// \u7ED1\u5B9A\u5931\u8D25\uFF0C\u9000\u51FA\u524D\u56DE\u6EDA\u6210\u529F\u76D1\u542C\uFF0C\u8FD4\u56DE C_ERR"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("sfd"),n("span",{class:"token operator"},"->"),s("fd"),n("span",{class:"token punctuation"},"["),s("sfd"),n("span",{class:"token operator"},"->"),s("count"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(` 
            `),n("span",{class:"token comment"},"// ... \u65E5\u5FD7\u8BB0\u5F55"),s(`

            `),n("span",{class:"token comment"},"// \u9000\u51FA\u524D\u56DE\u6EDA\u6210\u529F\u76D1\u542C"),s(`
            `),n("span",{class:"token function"},"closeSocketListeners"),n("span",{class:"token punctuation"},"("),s("sfd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"return"),s(" C_ERR"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("socket_mark_id "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token function"},"anetSetSockMarkId"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" sfd"),n("span",{class:"token operator"},"->"),s("fd"),n("span",{class:"token punctuation"},"["),s("sfd"),n("span",{class:"token operator"},"->"),s("count"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("socket_mark_id"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"anetNonBlock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s("sfd"),n("span",{class:"token operator"},"->"),s("fd"),n("span",{class:"token punctuation"},"["),s("sfd"),n("span",{class:"token operator"},"->"),s("count"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"anetCloexec"),n("span",{class:"token punctuation"},"("),s("sfd"),n("span",{class:"token operator"},"->"),s("fd"),n("span",{class:"token punctuation"},"["),s("sfd"),n("span",{class:"token operator"},"->"),s("count"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        sfd`),n("span",{class:"token operator"},"->"),s("count"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u521B\u5EFA\u4E00\u4E2A\u4E8B\u4EF6\u5904\u7406\u7A0B\u5E8F\u4EE5\u63A5\u53D7 TCP \u6216 TLS \u57DF\u5957\u63A5\u5B57\u4E2D\u7684\u65B0\u8FDE\u63A5\u3002\u8FD9\u9002\u7528\u4E8E\u6240\u6709\u5957\u63A5\u5B57 fd"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"createSocketAcceptHandler"),n("span",{class:"token punctuation"},"("),s("socketFds "),n("span",{class:"token operator"},"*"),s("sfd"),n("span",{class:"token punctuation"},","),s(" aeFileProc "),n("span",{class:"token operator"},"*"),s("accept_handler"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" sfd"),n("span",{class:"token operator"},"->"),s("count"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"aeCreateFileEvent"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("el"),n("span",{class:"token punctuation"},","),s(" sfd"),n("span",{class:"token operator"},"->"),s("fd"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" AE_READABLE"),n("span",{class:"token punctuation"},","),s(" accept_handler"),n("span",{class:"token punctuation"},","),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" AE_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(" j"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},">="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},")"),s(` 
                `),n("span",{class:"token function"},"aeDeleteFileEvent"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("el"),n("span",{class:"token punctuation"},","),s(" sfd"),n("span",{class:"token operator"},"->"),s("fd"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s(" AE_READABLE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"return"),s(" C_ERR"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),L={href:"https://github.com/redis/redis/blob/7.0/src/networking.c",target:"_blank",rel:"noopener noreferrer"},g=s("\u6E90\u7801\u5730\u5740"),C=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u542F\u52A8 \u8FDE\u63A5\u5E94\u7B54\u5904\u7406\u5668\uFF0C\u6267\u884C accpet()"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"acceptTcpHandler"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("el"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("privdata"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" mask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" cport"),n("span",{class:"token punctuation"},","),s(" cfd"),n("span",{class:"token punctuation"},","),s(" max "),n("span",{class:"token operator"},"="),s(" MAX_ACCEPTS_PER_CALL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" cip"),n("span",{class:"token punctuation"},"["),s("NET_IP_STR_LEN"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("el"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("privdata"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),s("max"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        cfd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetTcpAccept"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},","),s(" cip"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("cip"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("cport"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("cfd "),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"!="),s(" EWOULDBLOCK"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Accepting client connection: %s"'),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_VERBOSE"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},'"Accepted %s:%d"'),n("span",{class:"token punctuation"},","),s(" cip"),n("span",{class:"token punctuation"},","),s(" cport"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"acceptCommonHandler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"connCreateAcceptedSocket"),n("span",{class:"token punctuation"},"("),s("cfd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s("cip"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"acceptTLSHandler"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("el"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("privdata"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" mask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" cport"),n("span",{class:"token punctuation"},","),s(" cfd"),n("span",{class:"token punctuation"},","),s(" max "),n("span",{class:"token operator"},"="),s(" MAX_ACCEPTS_PER_CALL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" cip"),n("span",{class:"token punctuation"},"["),s("NET_IP_STR_LEN"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("el"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("privdata"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),s("max"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        cfd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetTcpAccept"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},","),s(" cip"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("cip"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("cport"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("cfd "),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"!="),s(" EWOULDBLOCK"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Accepting client connection: %s"'),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_VERBOSE"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},'"Accepted %s:%d"'),n("span",{class:"token punctuation"},","),s(" cip"),n("span",{class:"token punctuation"},","),s(" cport"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"acceptCommonHandler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"connCreateAcceptedTLS"),n("span",{class:"token punctuation"},"("),s("cfd"),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("tls_auth_clients"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s("cip"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"acceptUnixHandler"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("el"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("privdata"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" mask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" cfd"),n("span",{class:"token punctuation"},","),s(" max "),n("span",{class:"token operator"},"="),s(" MAX_ACCEPTS_PER_CALL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("el"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("privdata"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),s("max"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        cfd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetUnixAccept"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("cfd "),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("errno "),n("span",{class:"token operator"},"!="),s(" EWOULDBLOCK"),n("span",{class:"token punctuation"},")"),s(`
                `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Accepting client connection: %s"'),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("neterr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_VERBOSE"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},'"Accepted connection to %s"'),n("span",{class:"token punctuation"},","),s(" server"),n("span",{class:"token punctuation"},"."),s("unixsocket"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"acceptCommonHandler"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"connCreateAcceptedSocket"),n("span",{class:"token punctuation"},"("),s("cfd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s("CLIENT_UNIX_SOCKET"),n("span",{class:"token punctuation"},","),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// accpet "),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"acceptCommonHandler"),n("span",{class:"token punctuation"},"("),s("connection "),n("span",{class:"token operator"},"*"),s("conn"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" flags"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("ip"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    client `),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" conninfo"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("ip"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// ... \u5F53\u524D\u72B6\u6001\u4E0D\u4E3A acceping\uFF0C\u8BB0\u5F55\u65E5\u5FD7\uFF0C\u5173\u95ED\u8FDE\u63A5\uFF0C\u8FD4\u56DE"),s(`

    `),n("span",{class:"token comment"},"// ... \u9650\u5236 \u5E76\u53D1\u8FDE\u63A5\u7684\u6570\u91CF\u3002\u8D85\u51FA\u5219\u5173\u95ED\u8FDE\u63A5\uFF0C\u8FD4\u56DE \u9519\u8BEF\u4FE1\u606F"),s(`

    `),n("span",{class:"token comment"},"// \u521B\u5EFA\u5BA2\u6237\u7AEF\u8FDE\u63A5"),s(`
    `),n("span",{class:"token comment"},"// \u5982\u679C\u5931\u8D25\uFF0C\u8BB0\u5F55\u65E5\u5FD7\uFF0C\u5173\u95ED\u8FDE\u63A5\uFF0C\u8FD4\u56DE"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"createClient"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},'"Error registering fd event for the new client: %s (conn: %s)"'),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token function"},"connGetLastError"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token function"},"connGetInfo"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},","),s(" conninfo"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("conninfo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"connClose"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(` 
        `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    c`),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"|="),s(" flags"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u6267\u884C connAccept \u51FD\u6570"),s(`
    `),n("span",{class:"token comment"},"// \u6CE8\u610F connAccept() \u5728\u8FD9\u91CC\u53EF\u4EE5\u81EA\u7531\u5730\u505A\u4E24\u4EF6\u4E8B\uFF1A "),s(`
    `),n("span",{class:"token comment"},"// 1. \u7ACB\u5373\u8C03\u7528 clientAcceptHandler()\uFF1B "),s(`
    `),n("span",{class:"token comment"},"// 2. \u5B89\u6392\u672A\u6765\u5BF9 clientAcceptHandler() \u7684\u8C03\u7528\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"connAccept"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},","),s(" clientAcceptHandler"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"char"),s(" conninfo"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"connGetState"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" CONN_STATE_ERROR"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(`
                    `),n("span",{class:"token string"},'"Error accepting a client connection: %s (conn: %s)"'),n("span",{class:"token punctuation"},","),s(`
                    `),n("span",{class:"token function"},"connGetLastError"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"connGetInfo"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},","),s(" conninfo"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("conninfo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"freeClient"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"connGetPrivateData"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u521B\u5EFA\u5BA2\u6237\u7AEF\u8FDE\u63A5"),s(`
client `),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"createClient"),n("span",{class:"token punctuation"},"("),s("connection "),n("span",{class:"token operator"},"*"),s("conn"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    client `),n("span",{class:"token operator"},"*"),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zmalloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("client"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u5C06 NULL \u4F5C\u4E3A conn \u4F20\u9012\uFF0C\u53EF\u4EE5\u521B\u5EFA\u672A\u8FDE\u63A5\u7684\u5BA2\u6237\u7AEF\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"connEnableTcpNoDelay"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("tcpkeepalive"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"connKeepAlive"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},","),s("server"),n("span",{class:"token punctuation"},"."),s("tcpkeepalive"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5EFA\u7ACB \u957F\u8FDE\u63A5"),s(`
        `),n("span",{class:"token function"},"connSetReadHandler"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},","),s(" readQueryFromClient"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
        `),n("span",{class:"token function"},"connSetPrivateData"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},","),s(" c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    
    `),n("span",{class:"token comment"},"// c \u76F8\u5173\u53C2\u6570\u8BBE\u7F6E"),s(`
    c`),n("span",{class:"token operator"},"->"),s("id "),n("span",{class:"token operator"},"="),s(" client_id"),n("span",{class:"token punctuation"},";"),s(`
    c`),n("span",{class:"token operator"},"->"),s("resp "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},";"),s(`
    c`),n("span",{class:"token operator"},"->"),s("conn "),n("span",{class:"token operator"},"="),s(" conn"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`
    
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),s(` 
        `),n("span",{class:"token function"},"linkClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"initClientMultiState"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" c"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),R={href:"https://github.com/redis/redis/blob/7.0/src/anet.c",target:"_blank",rel:"noopener noreferrer"},h=s("\u6E90\u7801\u5730\u5740"),T=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u7ED1\u5B9A IPv4"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetTcpServer"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" port"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("bindaddr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" backlog"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"_anetTcpServer"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(" port"),n("span",{class:"token punctuation"},","),s(" bindaddr"),n("span",{class:"token punctuation"},","),s(" AF_INET"),n("span",{class:"token punctuation"},","),s(" backlog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u7ED1\u5B9A IPv6"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetTcp6Server"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" port"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("bindaddr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" backlog"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token function"},"_anetTcpServer"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(" port"),n("span",{class:"token punctuation"},","),s(" bindaddr"),n("span",{class:"token punctuation"},","),s(" AF_INET6"),n("span",{class:"token punctuation"},","),s(" backlog"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u542F\u52A8 IPv4 & IPv6 \u76D1\u542C"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"_anetTcpServer"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" port"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("bindaddr"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" af"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" backlog"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(" rv"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"char"),s(" _port"),n("span",{class:"token punctuation"},"["),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s("  "),n("span",{class:"token comment"},'/* strlen("65535") */'),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"addrinfo"),s(" hints"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("servinfo"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("p"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"snprintf"),n("span",{class:"token punctuation"},"("),s("_port"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"6"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},'"%d"'),n("span",{class:"token punctuation"},","),s("port"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("hints"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_family "),n("span",{class:"token operator"},"="),s(" af"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_socktype "),n("span",{class:"token operator"},"="),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},";"),s(`
    hints`),n("span",{class:"token punctuation"},"."),s("ai_flags "),n("span",{class:"token operator"},"="),s(" AI_PASSIVE"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5982\u679C bindaddr != NULL \u65E0\u6548"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("bindaddr "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"*"'),n("span",{class:"token punctuation"},","),s(" bindaddr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
        bindaddr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("af "),n("span",{class:"token operator"},"=="),s(" AF_INET6 "),n("span",{class:"token operator"},"&&"),s(" bindaddr "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"strcmp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"::*"'),n("span",{class:"token punctuation"},","),s(" bindaddr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
        bindaddr `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("rv "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getaddrinfo"),n("span",{class:"token punctuation"},"("),s("bindaddr"),n("span",{class:"token punctuation"},","),s("_port"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("hints"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("servinfo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"%s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"gai_strerror"),n("span",{class:"token punctuation"},"("),s("rv"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("p "),n("span",{class:"token operator"},"="),s(" servinfo"),n("span",{class:"token punctuation"},";"),s(" p "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(" p "),n("span",{class:"token operator"},"="),s(" p"),n("span",{class:"token operator"},"->"),s("ai_next"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("p"),n("span",{class:"token operator"},"->"),s("ai_family"),n("span",{class:"token punctuation"},","),s("p"),n("span",{class:"token operator"},"->"),s("ai_socktype"),n("span",{class:"token punctuation"},","),s("p"),n("span",{class:"token operator"},"->"),s("ai_protocol"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 \u7CFB\u7EDF\u8C03\u7528\uFF0C\u5EFA\u7ACB socket"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("af "),n("span",{class:"token operator"},"=="),s(" AF_INET6 "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"anetV6Only"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s("s"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token keyword"},"goto"),s(" error"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"anetSetReuseAddr"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s("s"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token keyword"},"goto"),s(" error"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"anetListen"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s("s"),n("span",{class:"token punctuation"},","),s("p"),n("span",{class:"token operator"},"->"),s("ai_addr"),n("span",{class:"token punctuation"},","),s("p"),n("span",{class:"token operator"},"->"),s("ai_addrlen"),n("span",{class:"token punctuation"},","),s("backlog"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s("  "),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
            s `),n("span",{class:"token operator"},"="),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"goto"),s(" end"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("p "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"unable to bind socket, errno: %d"'),n("span",{class:"token punctuation"},","),s(" errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"goto"),s(" error"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

error`),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    s `),n("span",{class:"token operator"},"="),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
end`),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"freeaddrinfo"),n("span",{class:"token punctuation"},"("),s("servinfo"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u542F\u52A8 socket \u76D1\u542C"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetListen"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"socklen_t"),s(" len"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" backlog"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"bind"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s("sa"),n("span",{class:"token punctuation"},","),s("len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s("  "),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"bind: %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listen"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(" backlog"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s("  "),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"listen: %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" ANET_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u542F\u52A8 Unix \u76D1\u542C"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetUnixServer"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("path"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"mode_t"),s(" perm"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" backlog"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},'"unix socket path too long (%zu), must be under %zu"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strlen"),n("span",{class:"token punctuation"},"("),s("path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetCreateSocket"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s("AF_LOCAL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"memset"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    sa`),n("span",{class:"token punctuation"},"."),s("sun_family "),n("span",{class:"token operator"},"="),s(" AF_LOCAL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"strncpy"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s("path"),n("span",{class:"token punctuation"},","),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"anetListen"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s("s"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s("backlog"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("perm"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token function"},"chmod"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},"."),s("sun_path"),n("span",{class:"token punctuation"},","),s(" perm"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetCreateSocket"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" domain"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"socket"),n("span",{class:"token punctuation"},"("),s("domain"),n("span",{class:"token punctuation"},","),s(" SOCK_STREAM"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"creating socket: %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"anetSetReuseAddr"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s("s"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u786E\u4FDD\u50CF redis \u57FA\u51C6\u6D4B\u8BD5\u8FD9\u6837\u7684\u8FDE\u63A5\u5BC6\u96C6\u578B\u4E8B\u7269\u80FD\u591F\u5173\u95ED\u6253\u5F00\u7684\u5957\u63A5\u5B57\u65E0\u6570\u6B21"),s(`
        `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" s"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetSetReuseAddr"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" yes "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// // \u786E\u4FDD\u50CF redis \u57FA\u51C6\u6D4B\u8BD5\u8FD9\u6837\u7684\u8FDE\u63A5\u5BC6\u96C6\u578B\u4E8B\u7269\u80FD\u591F\u5173\u95ED\u6253\u5F00\u7684\u5957\u63A5\u5B57\u65E0\u6570\u6B21"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"setsockopt"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),s(" SOL_SOCKET"),n("span",{class:"token punctuation"},","),s(" SO_REUSEADDR"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("yes"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("yes"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"setsockopt SO_REUSEADDR: %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" ANET_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u5F00\u542F TCP \u975E\u963B\u585E accept()"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetTcpAccept"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" serversock"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("ip"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"size_t"),s(" ip_len"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token operator"},"*"),s("port"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_storage"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"socklen_t"),s(" salen "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetGenericAccept"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s("serversock"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("salen"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},"."),s("ss_family "),n("span",{class:"token operator"},"=="),s(" AF_INET"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_in"),s(),n("span",{class:"token operator"},"*"),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_in"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ip"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token function"},"inet_ntop"),n("span",{class:"token punctuation"},"("),s("AF_INET"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token operator"},"->"),s("sin_addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s("ip"),n("span",{class:"token punctuation"},","),s("ip_len"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("port"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token operator"},"*"),s("port "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ntohs"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token operator"},"->"),s("sin_port"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_in6"),s(),n("span",{class:"token operator"},"*"),s("s "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_in6"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ip"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token function"},"inet_ntop"),n("span",{class:"token punctuation"},"("),s("AF_INET6"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token operator"},"->"),s("sin6_addr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s("ip"),n("span",{class:"token punctuation"},","),s("ip_len"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("port"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token operator"},"*"),s("port "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ntohs"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token operator"},"->"),s("sin6_port"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u5F00\u542F Unix \u975E\u963B\u585E accept()"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetUnixAccept"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr_un"),s(" sa"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"socklen_t"),s(" salen "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("sa"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"anetGenericAccept"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s("s"),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"&"),s("sa"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("salen"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" ANET_ERR"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"return"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u63A5\u53D7\u8FDE\u63A5\u5E76\u786E\u4FDD\u5957\u63A5\u5B57\u662F\u975E\u963B\u585E\u7684\uFF0C\u5E76\u4E14 CLOEXEC\u3002\u8FD4\u56DE\u65B0\u7684\u5957\u63A5\u5B57 FD\uFF0C\u5982\u679C\u51FA\u9519\u5219\u8FD4\u56DE -1"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"anetGenericAccept"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" s"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"sockaddr"),s(),n("span",{class:"token operator"},"*"),s("sa"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"socklen_t"),s(),n("span",{class:"token operator"},"*"),s("len"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"do"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token comment"},"// \u4F7F\u7528 linux \u4E0A\u7684 accept4() \u8C03\u7528\u540C\u65F6\u63A5\u53D7\u5E76\u5C06\u5957\u63A5\u5B57\u8BBE\u7F6E\u4E3A\u975E\u963B\u585E\u3002"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"ifdef"),s(),n("span",{class:"token expression"},"HAVE_ACCEPT4")]),s(`
        fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept4"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s(" sa"),n("span",{class:"token punctuation"},","),s(" len"),n("span",{class:"token punctuation"},","),s("  SOCK_NONBLOCK "),n("span",{class:"token operator"},"|"),s(" SOCK_CLOEXEC"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"else")]),s(`
        fd `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"accept"),n("span",{class:"token punctuation"},"("),s("s"),n("span",{class:"token punctuation"},","),s("sa"),n("span",{class:"token punctuation"},","),s("len"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"endif")]),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"=="),s(" EINTR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"accept: %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"ifndef"),s(),n("span",{class:"token expression"},"HAVE_ACCEPT4")]),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"anetCloexec"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"anetSetError"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"anetCloexec: %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"anetNonBlock"),n("span",{class:"token punctuation"},"("),s("err"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(" ANET_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" ANET_ERR"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token macro property"},[n("span",{class:"token directive-hash"},"#"),n("span",{class:"token directive keyword"},"endif")]),s(`
    `),n("span",{class:"token keyword"},"return"),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),N=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},`/*
 * \u5411\u4E8B\u4EF6\u5FAA\u73AF\u673A\u5236\u4E2D\u6CE8\u518C timer \u4E8B\u4EF6\u56DE\u8C03\uFF0C\u6BCF\u79D2\u8C03\u7528 server.hz \u6B21\uFF0C\u7528\u4E8E\u6267\u884C \u5F02\u6B65\u4EFB\u52A1\u3002
 * \u4F8B\u5982\uFF1A 
 * - \u6D3B\u52A8\u7684\u8FC7\u671F\u5BC6\u94A5\u6536\u96C6\uFF08\u5B83\u4E5F\u5728\u67E5\u627E\u65F6\u4EE5\u60F0\u6027\u65B9\u5F0F\u6267\u884C\uFF09\u3002 
 * - \u8F6F\u4EF6\u770B\u95E8\u72D7\u3002 
 * - \u66F4\u65B0\u4E00\u4E9B\u7EDF\u8BA1\u6570\u636E\u3002 
 * - DBs \u54C8\u5E0C\u8868\u7684\u589E\u91CF\u91CD\u65B0\u6563\u5217\u3002 
 * - \u89E6\u53D1 BGSAVE AOF \u91CD\u5199\uFF0C\u5E76\u5904\u7406\u7EC8\u6B62\u7684\u5B50\u8FDB\u7A0B 
 * - \u4E0D\u540C\u7C7B\u578B\u7684\u5BA2\u6237\u7AEF\u8D85\u65F6\u3002 
 * - \u590D\u5236\u91CD\u65B0\u8FDE\u63A5\u3002 
 * - \u66F4\u591A...
 * \u8FD9\u91CC\u76F4\u63A5\u8C03\u7528\u7684\u6240\u6709\u5185\u5BB9\u90FD\u5C06\u6BCF\u79D2\u8C03\u7528 server.hz \u6B21\uFF0C\u56E0\u6B64\u4E3A\u4E86\u9650\u5236\u6211\u4EEC\u60F3\u8981\u51CF\u5C11\u6267\u884C\u9891\u7387\u7684\u4E8B\u60C5\u7684\u6267\u884C\uFF0C\u4F7F\u7528\u4E86\u5B8F
 */`),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"serverCron"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"aeEventLoop"),s(),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" id"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("clientData"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("id"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"UNUSED"),n("span",{class:"token punctuation"},"("),s("clientData"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u8F6F\u4EF6\u770B\u95E8\u72D7\uFF1A\u5982\u679C\u6211\u4EEC\u6CA1\u6709\u8DB3\u591F\u5FEB\u5730\u8FD4\u56DE\u8FD9\u91CC\uFF0C\u5219\u4F20\u9012\u5C06\u5230\u8FBE\u4FE1\u53F7\u5904\u7406\u7A0B\u5E8F\u7684 SIGALRM\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("watchdog_period"),n("span",{class:"token punctuation"},")"),s(` 
        `),n("span",{class:"token function"},"watchdogScheduleSignal"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("watchdog_period"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token comment"},"// ... \u6536\u5230\u4E86 SIGTERM \u6216 SIGINT \u4FE1\u53F7\uFF0C\u4EE5\u5B89\u5168\u7684\u65B9\u5F0F\u5728\u6B64\u5904\u5173\u95ED"),s(`

    `),n("span",{class:"token comment"},"// ...\u663E\u793A\u4E00\u4E9B\u5173\u4E8E\u975E\u7A7A\u6570\u636E\u5E93\u7684\u4FE1\u606F"),s(`
    
    `),n("span",{class:"token comment"},"// \u663E\u793A\u6709\u5173\u5DF2\u8FDE\u63A5\u5BA2\u6237\u7AEF\u7684\u4FE1\u606F"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("server"),n("span",{class:"token punctuation"},"."),s("sentinel_mode"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"run_with_period"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"5000"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_DEBUG"),n("span",{class:"token punctuation"},","),s(`
                `),n("span",{class:"token string"},'"%lu clients connected (%lu replicas), %zu bytes in use"'),n("span",{class:"token punctuation"},","),s(`
                `),n("span",{class:"token function"},"listLength"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("clients"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"-"),n("span",{class:"token function"},"listLength"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("slaves"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
                `),n("span",{class:"token function"},"listLength"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("slaves"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(`
                `),n("span",{class:"token function"},"zmalloc_used_memory"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// \u6267\u884C \u5BA2\u6237\u7AEF\u5F02\u6B65 \u64CD\u4F5C"),s(`
    `),n("span",{class:"token function"},"clientsCron"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u5904\u7406 Redis \u6570\u636E\u5E93\u7684\u540E\u53F0\u64CD\u4F5C\u3002"),s(`
    `),n("span",{class:"token function"},"databasesCron"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u68C0\u6D4B\u5230\u6EE1\u8DB3\u76F8\u5173\u6761\u4EF6\uFF0C\u5219\u89E6\u53D1 AOF \u91CD\u5199"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"hasActiveChildProcess"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(`
        server`),n("span",{class:"token punctuation"},"."),s("aof_rewrite_scheduled "),n("span",{class:"token operator"},"&&"),s(`
        `),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"aofRewriteLimited"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"rewriteAppendOnlyFileBackground"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// \u68C0\u67E5 \u6B63\u5728\u8FDB\u884C\u7684 bgsave | AOF rewrite \u662F\u5426\u7EC8\u6B62"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"hasActiveChildProcess"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(),n("span",{class:"token function"},"ldbPendingChildren"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"run_with_period"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1000"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token function"},"receiveChildInfo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"checkChildrenDone"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token comment"},"// ... \u5982\u679C\u6CA1\u6709\u540E\u53F0\u8FDB\u884C rdb\uFF0C\u5219\u5224\u65AD\u5F53\u524D\u662F\u5426\u6709\u5FC5\u8981\u8FDB\u884C rdb"),s(`
        `),n("span",{class:"token comment"},"// ... \u5224\u65AD\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6 \u89E6\u53D1 AOF \u91CD\u5199"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token comment"},"// \u5224\u65AD\u662F\u5426\u6EE1\u8DB3\u6761\u4EF6\uFF0C\u8FDB\u884C AOF"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("aof_state "),n("span",{class:"token operator"},"=="),s(" AOF_ON  "),n("span",{class:"token operator"},"||"),s(" server"),n("span",{class:"token punctuation"},"."),s("aof_state "),n("span",{class:"token operator"},"=="),s(" AOF_WAIT_REWRITE"),n("span",{class:"token punctuation"},")"),s(` 
         `),n("span",{class:"token operator"},"&&"),s(" server"),n("span",{class:"token punctuation"},"."),s("aof_flush_postponed_start"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"flushAppendOnlyFile"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token comment"},"// AOF \u5199\u5165\u9519\u8BEF\uFF1A\u5C1D\u8BD5\u91CD\u65B0\u8FDB\u884C AOF"),s(`
    `),n("span",{class:"token function"},"run_with_period"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1000"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("aof_state "),n("span",{class:"token operator"},"=="),s(" AOF_ON  "),n("span",{class:"token operator"},"||"),s(" server"),n("span",{class:"token punctuation"},"."),s("aof_state "),n("span",{class:"token operator"},"=="),s(" AOF_WAIT_REWRITE"),n("span",{class:"token punctuation"},")"),s(`
             `),n("span",{class:"token operator"},"&&"),s(" server"),n("span",{class:"token punctuation"},"."),s("aof_last_write_status "),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token function"},"flushAppendOnlyFile"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token comment"},"// \u540C\u6B65\u590D\u5236 "),s(`
    `),n("span",{class:"token comment"},"// \u7528\u4E8E \u91CD\u65B0\u8FDE\u63A5\u5230 master\u3001\u68C0\u6D4B\u4F20\u8F93\u5931\u8D25\u3001\u542F\u52A8\u540E\u53F0 RDB \u4F20\u8F93\u7B49\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("failover_state "),n("span",{class:"token operator"},"!="),s(" NO_FAILOVER"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u5F53\u524D\u975E \u6545\u969C\u8F6C\u79FB \u72B6\u6001"),s(`
        `),n("span",{class:"token function"},"run_with_period"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token function"},"replicationCron"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"run_with_period"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1000"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token function"},"replicationCron"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// \u5982\u679C\u5F00\u542F\u4E86\u96C6\u7FA4\uFF0C\u5219 \u5F00\u542F\u96C6\u7FA4"),s(`
    `),n("span",{class:"token function"},"run_with_period"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("cluster_enabled"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token function"},"clusterCron"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token comment"},"// \u5982\u679C\u5F00\u542F\u4E86 \u54E8\u5175\uFF0C\u5219 \u89E6\u53D1\u54E8\u5175\u8BA1\u65F6\u5668"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("sentinel_mode"),n("span",{class:"token punctuation"},")"),s(` 
        `),n("span",{class:"token function"},"sentinelTimer"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// ..."),s(`
    
    `),n("span",{class:"token comment"},"// \u5982\u679C\u5F00\u542F\u4E86\u76F8\u5173\u6A21\u5757\uFF0C\u5219\u542F\u52A8\u6A21\u5757"),s(`
    `),n("span",{class:"token function"},"run_with_period"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"moduleCount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token function"},"modulesCron"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token comment"},"// \u89E6\u53D1 \u5B9A\u65F6 \u5FAA\u73AF\u6A21\u5757\u4E8B\u4EF6"),s(`
    RedisModuleCronLoopV1 ei `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),s("REDISMODULE_CRON_LOOP_VERSION"),n("span",{class:"token punctuation"},","),s("server"),n("span",{class:"token punctuation"},"."),s("hz"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"moduleFireServerEvent"),n("span",{class:"token punctuation"},"("),s("REDISMODULE_EVENT_CRON_LOOP"),n("span",{class:"token punctuation"},","),s(`
                          `),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(`
                          `),n("span",{class:"token operator"},"&"),s("ei"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    server`),n("span",{class:"token punctuation"},"."),s("cronloops"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5FAA\u73AF\u6570\u589E\u52A0"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"1000"),n("span",{class:"token operator"},"/"),s("server"),n("span",{class:"token punctuation"},"."),s("hz"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),O=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u521D\u59CB\u5316 Server \u7684\u540E\u7F6E\u5904\u7406"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"InitServerLast"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
  `),n("span",{class:"token function"},"bioInit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u521D\u59CB\u5316\u540E\u53F0\u7EBF\u7A0B"),s(`
  `),n("span",{class:"token function"},"initThreadedIO"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"set_jemalloc_bg_thread"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("jemalloc_bg_thread"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
  server`),n("span",{class:"token punctuation"},"."),s("initial_memory_usage "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zmalloc_used_memory"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),I=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u521D\u59CB\u5316\u540E\u53F0\u7CFB\u7EDF\uFF0C\u4EA7\u751F\u7EBF\u7A0B\u3002"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"bioInit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token class-name"},"pthread_attr_t"),s(" attr"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"pthread_t"),s(" thread"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"size_t"),s(" stacksize"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u72B6\u6001\u53D8\u91CF\u548C\u5BF9\u8C61\u7684 \u521D\u59CB\u5316"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" BIO_NUM_OPS"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"pthread_mutex_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("bio_mutex"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"pthread_cond_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("bio_newjob_cond"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"pthread_cond_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("bio_step_cond"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        bio_jobs`),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"listCreate"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        bio_pending`),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// \u8BBE\u7F6E\u9ED8\u8BA4\u5806\u6808\u5927\u5C0F\uFF0C\u5B83\u5728\u67D0\u4E9B\u7CFB\u7EDF\u4E2D\u53EF\u80FD\u5F88\u5C0F"),s(`
    `),n("span",{class:"token function"},"pthread_attr_init"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"pthread_attr_getstacksize"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("stacksize"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("stacksize"),n("span",{class:"token punctuation"},")"),s(" stacksize "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(` 
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("stacksize "),n("span",{class:"token operator"},"<"),s(" REDIS_THREAD_STACK_SIZE"),n("span",{class:"token punctuation"},")"),s(` 
        stacksize `),n("span",{class:"token operator"},"*="),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"pthread_attr_setstacksize"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},","),s(" stacksize"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u51C6\u5907\u597D\u751F\u6210\u6211\u4EEC\u7684\u7EBF\u7A0B\u3002\u6211\u4EEC\u4F7F\u7528\u7EBF\u7A0B\u51FD\u6570\u63A5\u53D7\u7684\u5355\u4E2A\u53C2\u6570\u6765\u4F20\u9012\u7EBF\u7A0B\u8D1F\u8D23\u7684\u4F5C\u4E1A ID\u3002"),s(`
    `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" BIO_NUM_OPS"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("arg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token comment"},"// \u521B\u5EFA\u7EBF\u7A0B\uFF0C\u6267\u884C\u540E\u53F0\u4EFB\u52A1"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"pthread_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("thread"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("attr"),n("span",{class:"token punctuation"},","),s("bioProcessBackgroundJobs"),n("span",{class:"token punctuation"},","),s("arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),n("span",{class:"token string"},`"Fatal: Can't initialize Background Jobs."`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token function"},"exit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        bio_threads`),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"="),s(" thread"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u6267\u884C\u540E\u53F0\u4EFB\u52A1"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"bioProcessBackgroundJobs"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("arg"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    bio_job `),n("span",{class:"token operator"},"*"),s("job"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"long"),s(" type "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"unsigned"),s(),n("span",{class:"token keyword"},"long"),n("span",{class:"token punctuation"},")"),s(" arg"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"sigset_t"),s(" sigset"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("type "),n("span",{class:"token operator"},">="),s(" BIO_NUM_OPS"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u68C0\u67E5\u7C7B\u578B\u662F\u5426 \u6EE1\u8DB3\u6761\u4EF6"),s(`
        `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(`
            `),n("span",{class:"token string"},'"Warning: bio thread started with wrong type %lu"'),n("span",{class:"token punctuation"},","),s("type"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"switch"),s(),n("span",{class:"token punctuation"},"("),s("type"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u7C7B\u578B\u5224\u65AD"),s(`
    `),n("span",{class:"token keyword"},"case"),s(" BIO_CLOSE_FILE"),n("span",{class:"token operator"},":"),s(`
        `),n("span",{class:"token function"},"redis_set_thread_title"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bio_close_file"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(" BIO_AOF_FSYNC"),n("span",{class:"token operator"},":"),s(`
        `),n("span",{class:"token function"},"redis_set_thread_title"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bio_aof_fsync"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5F02\u6B65 AOF"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"case"),s(" BIO_LAZY_FREE"),n("span",{class:"token operator"},":"),s(`
        `),n("span",{class:"token function"},"redis_set_thread_title"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"bio_lazy_free"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u61D2\u5220\u9664"),s(`
        `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        listNode `),n("span",{class:"token operator"},"*"),s("ln"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token comment"},"// \u5FAA\u73AF\u59CB\u7EC8\u4EE5 \u83B7\u5F97\u9501 \u5F00\u59CB"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listLength"),n("span",{class:"token punctuation"},"("),s("bio_jobs"),n("span",{class:"token punctuation"},"["),s("type"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"pthread_cond_wait"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("bio_newjob_cond"),n("span",{class:"token punctuation"},"["),s("type"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("bio_mutex"),n("span",{class:"token punctuation"},"["),s("type"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        
        `),n("span",{class:"token comment"},"// ..."),s(`

        `),n("span",{class:"token comment"},"// \u89E3\u9501"),s(`
        `),n("span",{class:"token function"},"pthread_mutex_unlock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("bio_mutex"),n("span",{class:"token punctuation"},"["),s("type"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(` 

        `),n("span",{class:"token comment"},"// \u6839\u636E\u4F5C\u4E1A\u7C7B\u578B\u5904\u7406\u4F5C\u4E1A\u3002"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("type "),n("span",{class:"token operator"},"=="),s(" BIO_CLOSE_FILE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("job"),n("span",{class:"token operator"},"->"),s("fd_args"),n("span",{class:"token punctuation"},"."),s("need_fsync"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token function"},"redis_fsync"),n("span",{class:"token punctuation"},"("),s("job"),n("span",{class:"token operator"},"->"),s("fd_args"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token function"},"close"),n("span",{class:"token punctuation"},"("),s("job"),n("span",{class:"token operator"},"->"),s("fd_args"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("type "),n("span",{class:"token operator"},"=="),s(" BIO_AOF_FSYNC"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u5F02\u6B65 AOF"),s(`
            `),n("span",{class:"token comment"},"// fd \u53EF\u80FD\u4F1A\u88AB\u4E3B\u7EBF\u7A0B\u5173\u95ED\u5E76\u91CD\u65B0\u7528\u4E8E\u53E6\u4E00\u4E2A\u5957\u63A5\u5B57\u3001\u7BA1\u9053\u6216\u6587\u4EF6\u3002"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"redis_fsync"),n("span",{class:"token punctuation"},"("),s("job"),n("span",{class:"token operator"},"->"),s("fd_args"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EBADF "),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINVAL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token keyword"},"int"),s(" last_status"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token function"},"atomicGet"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("aof_bio_fsync_status"),n("span",{class:"token punctuation"},","),s("last_status"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token function"},"atomicSet"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("aof_bio_fsync_status"),n("span",{class:"token punctuation"},","),s("C_ERR"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token function"},"atomicSet"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("aof_bio_fsync_errno"),n("span",{class:"token punctuation"},","),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("last_status "),n("span",{class:"token operator"},"=="),s(" C_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    `),n("span",{class:"token function"},"serverLog"),n("span",{class:"token punctuation"},"("),s("LL_WARNING"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"Fail to fsync the AOF file: %s"'),n("span",{class:"token punctuation"},","),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token function"},"atomicSet"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("aof_bio_fsync_status"),n("span",{class:"token punctuation"},","),s("C_OK"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("type "),n("span",{class:"token operator"},"=="),s(" BIO_LAZY_FREE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            job`),n("span",{class:"token operator"},"->"),s("free_args"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"free_fn"),n("span",{class:"token punctuation"},"("),s("job"),n("span",{class:"token operator"},"->"),s("free_args"),n("span",{class:"token punctuation"},"."),s("free_args"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"serverPanic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Wrong job type in bioProcessBackgroundJobs()."'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token function"},"zfree"),n("span",{class:"token punctuation"},"("),s("job"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token function"},"pthread_mutex_lock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("bio_mutex"),n("span",{class:"token punctuation"},"["),s("type"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5728\u91CD\u590D\u5FAA\u73AF\u4E4B\u524D\u518D\u6B21\u9501\u5B9A\uFF0C\u5982\u679C\u4E0D\u518D\u6709\u4F5C\u4E1A\u8981\u5904\u7406\uFF0C\u6211\u4EEC\u5C06\u5728 pthread_cond_wait() \u4E2D\u518D\u6B21\u963B\u585E\u3002"),s(`
        `),n("span",{class:"token function"},"listDelNode"),n("span",{class:"token punctuation"},"("),s("bio_jobs"),n("span",{class:"token punctuation"},"["),s("type"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},","),s("ln"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        bio_pending`),n("span",{class:"token punctuation"},"["),s("type"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token function"},"pthread_cond_broadcast"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("bio_step_cond"),n("span",{class:"token punctuation"},"["),s("type"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5982\u679C\u6709\u7684\u8BDD\uFF0C\u53D6\u6D88\u963B\u6B62 bioWaitStepOfType() \u4E0A\u963B\u585E\u7684\u7EBF\u7A0B\u3002"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),S=i('<hr><h2 id="_2-\u542F\u52A8\u4E8B\u4EF6\u5FAA\u73AF" tabindex="-1"><a class="header-anchor" href="#_2-\u542F\u52A8\u4E8B\u4EF6\u5FAA\u73AF" aria-hidden="true">#</a> 2. \u542F\u52A8\u4E8B\u4EF6\u5FAA\u73AF</h2><ol><li><code>aeEventLoop</code> \u63D0\u4F9B\u4E86 <ul><li><strong>\u521B\u5EFA \u4E8B\u4EF6\u5FAA\u73AF\u673A\u5236</strong></li><li><strong>\u6CE8\u518C timer \u4E8B\u4EF6</strong></li><li><strong>\u6CE8\u518C file \u4E8B\u4EF6</strong></li><li><strong>\u542F\u52A8 \u4E8B\u4EF6\u5FAA\u73AF\u673A\u5236</strong></li></ul></li><li><code>aeEventLoop</code> \u4E2D\u901A\u8FC7\u8C03\u7528\u5177\u4F53\u7684 \u591A\u8DEF\u590D\u7528\u65B9\u6CD5\u5B9E\u73B0\u591A\u79CD IO \u591A\u8DEF\u590D\u7528\uFF0C\u6EE1\u8DB3\u4E0D\u540C\u64CD\u4F5C\u7CFB\u7EDF\u7684\u8981\u6C42 <ul><li><code>select</code></li><li><code>epoll</code><ul><li>Linux \u7CFB\u7EDF\u72EC\u6709\uFF0C\u4F18\u5148\u4F7F\u7528</li></ul></li><li><code>kqueue</code><ul><li>macOS \u7CFB\u7EDF\uFF0C\u4F18\u5148\u4F7F\u7528\uFF0C\u7C7B\u4F3C\u4E8E epoll \u673A\u5236</li></ul></li><li><code>evport</code><ul><li>illumos \u7CFB\u7EDF\uFF0C\u4F18\u5148\u4F7F\u7528</li></ul></li></ul></li></ol>',3),P=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"aeEventLoop"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" maxfd"),n("span",{class:"token punctuation"},";"),s("   "),n("span",{class:"token comment"},"/* highest file descriptor currently registered */"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" setsize"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* max number of file descriptors tracked */"),s(`
    `),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" timeEventNextId"),n("span",{class:"token punctuation"},";"),s(`
    aeFileEvent `),n("span",{class:"token operator"},"*"),s("events"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Registered events */"),s(`
    aeFiredEvent `),n("span",{class:"token operator"},"*"),s("fired"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Fired events */"),s(`
    aeTimeEvent `),n("span",{class:"token operator"},"*"),s("timeEventHead"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" stop"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("apidata"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* This is used for polling API specific data */"),s(`
    aeBeforeSleepProc `),n("span",{class:"token operator"},"*"),s("beforesleep"),n("span",{class:"token punctuation"},";"),s(`
    aeBeforeSleepProc `),n("span",{class:"token operator"},"*"),s("aftersleep"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" flags"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" aeEventLoop"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token comment"},"// \u521B\u5EFA\u4E8B\u4EF6\u5FAA\u73AF"),s(`
aeEventLoop `),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"aeCreateEventLoop"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" setsize"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeEventLoop `),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" i"),n("span",{class:"token punctuation"},";"),s(`
    
    `),n("span",{class:"token comment"},"// ..."),s(`
    
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"aeApiCreate"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
         `),n("span",{class:"token keyword"},"goto"),s(" err"),n("span",{class:"token punctuation"},";"),s(`
    
    `),n("span",{class:"token comment"},"// ..."),s(`
    `),n("span",{class:"token keyword"},"return"),s(" eventLoop"),n("span",{class:"token punctuation"},";"),s(`

err`),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"zfree"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"zfree"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token operator"},"->"),s("fired"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"zfree"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u5220\u9664\u4E8B\u4EF6\u5FAA\u73AF\u673A\u5236"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"aeDeleteEventLoop"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`
    `),n("span",{class:"token function"},"zfree"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u6DFB\u52A0 \u6587\u4EF6\u76D1\u542C\u4E8B\u4EF6"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeCreateFileEvent"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(` 
                      `),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(` 
                      `),n("span",{class:"token keyword"},"int"),s(" mask"),n("span",{class:"token punctuation"},","),s(`
                      aeFileProc `),n("span",{class:"token operator"},"*"),s("proc"),n("span",{class:"token punctuation"},","),s(` 
                      `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("clientData"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"aeApiAddEvent"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},","),s(" mask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" AE_ERR"),n("span",{class:"token punctuation"},";"),s(`
    
    `),n("span",{class:"token comment"},"// ..."),s(`
    `),n("span",{class:"token keyword"},"return"),s(" AE_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u5220\u9664 \u6587\u4EF6\u76D1\u542C\u4E8B\u4EF6"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"aeDeleteFileEvent"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" mask"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token function"},"aeApiDelEvent"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},","),s(" fd"),n("span",{class:"token punctuation"},","),s(" mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    
    `),n("span",{class:"token comment"},"// ..."),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u6DFB\u52A0 timer \u76D1\u542C\u4E8B\u4EF6"),s(`
`),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token function"},"aeCreateTimeEvent"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(` 
                            `),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" milliseconds"),n("span",{class:"token punctuation"},","),s(`
                            aeTimeProc `),n("span",{class:"token operator"},"*"),s("proc"),n("span",{class:"token punctuation"},","),s(` 
                            `),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token operator"},"*"),s("clientData"),n("span",{class:"token punctuation"},","),s(`
                            aeEventFinalizerProc `),n("span",{class:"token operator"},"*"),s("finalizerProc"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" id "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("timeEventNextId"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
    aeTimeEvent `),n("span",{class:"token operator"},"*"),s("te"),n("span",{class:"token punctuation"},";"),s(`

    te `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zmalloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("te"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("te "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(" AE_ERR"),n("span",{class:"token punctuation"},";"),s(`
    te`),n("span",{class:"token operator"},"->"),s("id "),n("span",{class:"token operator"},"="),s(" id"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// te->..."),s(`
    
    eventLoop`),n("span",{class:"token operator"},"->"),s("timeEventHead "),n("span",{class:"token operator"},"="),s(" te"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" id"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u5220\u9664 timer \u76D1\u542C\u4E8B\u4EF6"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeDeleteTimeEvent"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" id"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token punctuation"},"{"),s(`
    aeTimeEvent `),n("span",{class:"token operator"},"*"),s("te "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("timeEventHead"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),s("te"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u904D\u5386\u67E5\u627E\u8981\u5220\u9664\u7684 timer"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("te"),n("span",{class:"token operator"},"->"),s("id "),n("span",{class:"token operator"},"=="),s(" id"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            te`),n("span",{class:"token operator"},"->"),s("id "),n("span",{class:"token operator"},"="),s(" AE_DELETED_EVENT_ID"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"return"),s(" AE_OK"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        te `),n("span",{class:"token operator"},"="),s(" te"),n("span",{class:"token operator"},"->"),s("next"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" AE_ERR"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u672A\u627E\u5230\u5177\u6709\u6307\u5B9A ID \u7684\u4E8B\u4EF6"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u542F\u52A8\u4E8B\u4EF6\u5FAA\u73AF"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"aeMain"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    eventLoop`),n("span",{class:"token operator"},"->"),s("stop "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("eventLoop"),n("span",{class:"token operator"},"->"),s("stop"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"aeProcessEvents"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},","),s(" AE_ALL_EVENTS"),n("span",{class:"token operator"},"|"),s(`
                                   AE_CALL_BEFORE_SLEEP`),n("span",{class:"token operator"},"|"),s(`
                                   AE_CALL_AFTER_SLEEP`),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u4E8B\u4EF6\u5FAA\u73AF \u5177\u4F53\u6267\u884C\u903B\u8F91"),s(`
`),n("span",{class:"token comment"},"// \u5904\u7406\u6BCF\u4E2A\u6302\u8D77\u7684 timer \u4E8B\u4EF6\uFF0C\u7136\u540E\u5904\u7406\u6BCF\u4E2A\u6302\u8D77\u7684 file \u4E8B\u4EF6\uFF08\u53EF\u80FD\u7531\u521A\u521A\u5904\u7406\u7684\u65F6\u95F4\u4E8B\u4EF6\u56DE\u8C03\u6CE8\u518C\uFF09\u3002"),s(`
`),n("span",{class:"token comment"},"// \u5982\u679C\u6CA1\u6709\u7279\u6B8A\u6807\u5FD7\uFF0C\u8BE5\u51FD\u6570\u4F1A\u4E00\u76F4\u4F11\u7720\uFF0C\u76F4\u5230\u67D0\u4E2A\u6587\u4EF6\u4E8B\u4EF6\u89E6\u53D1\u6216\u4E0B\u4E00\u6B21\u4E8B\u4EF6\u53D1\u751F\uFF08\u5982\u679C\u6709\uFF09\u3002"),s(`
`),n("span",{class:"token comment"},"// \u8BE5\u51FD\u6570\u8FD4\u56DE\u5904\u7406\u7684\u4E8B\u4EF6\u6570"),s(`
`),n("span",{class:"token comment"},"//"),s(`
`),n("span",{class:"token comment"},"// 1) \u5982\u679C flags \u4E3A 0\uFF0C\u5219\u8BE5\u51FD\u6570\u4E0D\u6267\u884C\u4EFB\u4F55\u64CD\u4F5C\u5E76\u8FD4\u56DE\u3002"),s(`
`),n("span",{class:"token comment"},"// 2) \u5982\u679C flags \u8BBE\u7F6E\u4E86 AE_ALL_EVENTS\uFF0C\u5219\u5904\u7406\u6240\u6709\u7C7B\u578B\u7684\u4E8B\u4EF6\u3002"),s(`
`),n("span",{class:"token comment"},"// 3) \u5982\u679C flags \u8BBE\u7F6E\u4E86 AE_FILE_EVENTS\uFF0C\u5219\u5904\u7406\u6587\u4EF6\u4E8B\u4EF6\u3002"),s(`
`),n("span",{class:"token comment"},"// 4) \u5982\u679C flags \u8BBE\u7F6E\u4E86 AE_TIME_EVENTS\uFF0C\u5219\u5904\u7406\u65F6\u95F4\u4E8B\u4EF6\u3002"),s(`
`),n("span",{class:"token comment"},"// 5) \u5982\u679C flags \u8BBE\u7F6E\u4E86 AE_DONT_WAIT\uFF0C\u5219\u51FD\u6570\u4F1A\u5728\u5904\u7406\u5B8C\u6240\u6709\u65E0\u9700\u7B49\u5F85\u5373\u53EF\u5904\u7406\u7684\u4E8B\u4EF6\u540E\u5C3D\u5FEB\u8FD4\u56DE\u3002"),s(`
`),n("span",{class:"token comment"},"// 6) \u5982\u679C flags \u8BBE\u7F6E\u4E86 AE_CALL_AFTER_SLEEP\uFF0C\u5219\u8C03\u7528 aftersleep \u56DE\u8C03\u3002"),s(`
`),n("span",{class:"token comment"},"// 7) \u5982\u679C flags \u8BBE\u7F6E\u4E86 AE_CALL_BEFORE_SLEEP\uFF0C\u5219\u8C03\u7528 beforesleep \u56DE\u8C03\u3002"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeProcessEvents"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" flags"),n("span",{class:"token punctuation"},")"),s(`
`),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" processed "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" numevents"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),n("span",{class:"token punctuation"},"("),s("flags "),n("span",{class:"token operator"},"&"),s(" AE_TIME_EVENTS"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"!"),n("span",{class:"token punctuation"},"("),s("flags "),n("span",{class:"token operator"},"&"),s(" AE_FILE_EVENTS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u6CA1\u4E8B\u505A\uFF1F\u5C3D\u5FEB\u8FD4\u56DE"),s(`

    `),n("span",{class:"token comment"},"// \u5373\u4F7F\u6CA1\u6709\u8981\u5904\u7406\u7684\u6587\u4EF6\u4E8B\u4EF6\uFF0C\u53EA\u8981\u6211\u4EEC\u60F3\u5904\u7406\u65F6\u95F4\u4E8B\u4EF6\uFF0C\u6211\u4EEC\u4E5F\u60F3\u8C03\u7528 select()\uFF0C\u4EE5\u4FBF\u4F11\u7720\u76F4\u5230\u4E0B\u4E00\u6B21\u65F6\u95F4\u4E8B\u4EF6\u51C6\u5907\u597D\u89E6\u53D1\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token operator"},"->"),s("maxfd "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"||"),s(`
        `),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("flags "),n("span",{class:"token operator"},"&"),s(" AE_TIME_EVENTS"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token operator"},"!"),n("span",{class:"token punctuation"},"("),s("flags "),n("span",{class:"token operator"},"&"),s(" AE_DONT_WAIT"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"timeval"),s(" tv"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"*"),s("tvp"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token class-name"},"int64_t"),s(" usUntilTimer "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token comment"},"// ..."),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token operator"},"->"),s("beforesleep "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(" flags "),n("span",{class:"token operator"},"&"),s(" AE_CALL_BEFORE_SLEEP"),n("span",{class:"token punctuation"},")"),s(`
            eventLoop`),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"beforesleep"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u8C03\u7528 beforesleep \u56DE\u8C03"),s(`

        numevents `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"aeApiPoll"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},","),s(" tvp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 \u8C03\u7528\u591A\u8DEF\u590D\u7528 API\uFF0C\u53EA\u4F1A\u5728\u8D85\u65F6\u6216\u67D0\u4E9B\u4E8B\u4EF6\u89E6\u53D1\u65F6\u8FD4\u56DE\u3002"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token operator"},"->"),s("aftersleep "),n("span",{class:"token operator"},"!="),s(),n("span",{class:"token constant"},"NULL"),s(),n("span",{class:"token operator"},"&&"),s(" flags "),n("span",{class:"token operator"},"&"),s(" AE_CALL_AFTER_SLEEP"),n("span",{class:"token punctuation"},")"),s(`
            eventLoop`),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"aftersleep"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u8C03\u7528 aftersleep \u56DE\u8C03"),s(`

        `),n("span",{class:"token comment"},"// \u904D\u5386 IO \u591A\u8DEF\u590D\u7528\u8FD4\u56DE\u7684 file \u4E8B\u4EF6\uFF0C\u6267\u884C"),s(`
        `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" numevents"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"int"),s(" fd "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("fired"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},";"),s(`
            aeFileEvent `),n("span",{class:"token operator"},"*"),s("fe "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("eventLoop"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},"["),s("fd"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"int"),s(" mask "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("fired"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("mask"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"int"),s(" fired "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5F53\u524D fd \u89E6\u53D1\u7684\u4E8B\u4EF6\u6570\u3002"),s(`

            `),n("span",{class:"token comment"},`/* \u901A\u5E38\u6211\u4EEC\u5148\u6267\u884C\u53EF\u8BFB\u4E8B\u4EF6\uFF0C\u7136\u540E\u518D\u6267\u884C\u53EF\u5199\u4E8B\u4EF6\u3002\u8FD9\u5F88\u6709\u7528\uFF0C\u56E0\u4E3A\u6709\u65F6\u6211\u4EEC\u53EF\u4EE5\u5728\u5904\u7406\u67E5\u8BE2\u540E\u7ACB\u5373\u63D0\u4F9B\u67E5\u8BE2\u7684\u56DE\u590D\u3002
             *
             * \u4F46\u662F\uFF0C\u5982\u679C\u5728\u63A9\u7801\u4E2D\u8BBE\u7F6E\u4E86 AE_BARRIER\uFF0C\u6211\u4EEC\u7684\u5E94\u7528\u7A0B\u5E8F\u4F1A\u8981\u6C42\u6211\u4EEC\u505A\u76F8\u53CD\u7684\u4E8B\u60C5\uFF1A\u6C38\u8FDC\u4E0D\u8981\u5728\u53EF\u8BFB\u4E8B\u4EF6\u4E4B\u540E\u89E6\u53D1\u53EF\u5199\u4E8B\u4EF6\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u6211\u4EEC\u53CD\u8F6C\u8C03\u7528\u3002
             * \u4F8B\u5982\uFF0C\u5F53\u6211\u4EEC\u60F3\u5728 beforeSleep() \u94A9\u5B50\u4E2D\u505A\u4E00\u4E9B\u4E8B\u60C5\u65F6\uFF0C\u8FD9\u5F88\u6709\u7528\uFF0C\u6BD4\u5982\u5728\u56DE\u590D\u5BA2\u6237\u7AEF\u4E4B\u524D\u5C06\u6587\u4EF6\u540C\u6B65\u5230\u78C1\u76D8\u3002 */`),s(`
            `),n("span",{class:"token keyword"},"int"),s(" invert "),n("span",{class:"token operator"},"="),s(" fe"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_BARRIER"),n("span",{class:"token punctuation"},";"),s(`

            `),n("span",{class:"token comment"},"// \u5982\u679C\u8C03\u7528\u5E8F\u5217\u672A\u53CD\u8F6C\uFF0C\u5219\u89E6\u53D1\u53EF\u8BFB\u4E8B\u4EF6\u3002"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("invert "),n("span",{class:"token operator"},"&&"),s(" fe"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" mask "),n("span",{class:"token operator"},"&"),s(" AE_READABLE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                fe`),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"rfileProc"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},","),s("fd"),n("span",{class:"token punctuation"},","),s("fe"),n("span",{class:"token operator"},"->"),s("clientData"),n("span",{class:"token punctuation"},","),s("mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                fired`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
                fe `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("eventLoop"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},"["),s("fd"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Refresh in case of resize. */"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token comment"},"// \u89E6\u53D1\u53EF\u5199\u4E8B\u4EF6\u3002"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fe"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" mask "),n("span",{class:"token operator"},"&"),s(" AE_WRITABLE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("fired "),n("span",{class:"token operator"},"||"),s(" fe"),n("span",{class:"token operator"},"->"),s("wfileProc "),n("span",{class:"token operator"},"!="),s(" fe"),n("span",{class:"token operator"},"->"),s("rfileProc"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    fe`),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"wfileProc"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},","),s("fd"),n("span",{class:"token punctuation"},","),s("fe"),n("span",{class:"token operator"},"->"),s("clientData"),n("span",{class:"token punctuation"},","),s("mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    fired`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`

            `),n("span",{class:"token comment"},"// \u5982\u679C\u6211\u4EEC\u5FC5\u987B\u53CD\u8F6C\u8C03\u7528\uFF0C\u8BF7\u5728\u53EF\u5199\u4E8B\u4EF6\u4E4B\u540E\u7ACB\u5373\u89E6\u53D1\u53EF\u8BFB\u4E8B\u4EF6\u3002"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("invert"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                fe `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("eventLoop"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},"["),s("fd"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5728\u8C03\u6574\u5927\u5C0F\u7684\u60C5\u51B5\u4E0B\u5237\u65B0\u3002"),s(`
                `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("fe"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" mask "),n("span",{class:"token operator"},"&"),s(" AE_READABLE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(`
                    `),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("fired "),n("span",{class:"token operator"},"||"),s(" fe"),n("span",{class:"token operator"},"->"),s("wfileProc "),n("span",{class:"token operator"},"!="),s(" fe"),n("span",{class:"token operator"},"->"),s("rfileProc"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    fe`),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"rfileProc"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},","),s("fd"),n("span",{class:"token punctuation"},","),s("fe"),n("span",{class:"token operator"},"->"),s("clientData"),n("span",{class:"token punctuation"},","),s("mask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    fired`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
            processed`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("flags "),n("span",{class:"token operator"},"&"),s(" AE_TIME_EVENTS"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u68C0\u67E5\u65F6\u95F4\u4E8B\u4EF6"),s(`
        processed `),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token function"},"processTimeEvents"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`

    `),n("span",{class:"token keyword"},"return"),s(" processed"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u8FD4\u56DE\u5904\u7406\u7684\u6587\u4EF6\u65F6\u95F4\u4E8B\u4EF6\u7684\u6570\u91CF"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u5904\u7406 timer \u4E8B\u4EF6"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"processTimeEvents"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" processed "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    aeTimeEvent `),n("span",{class:"token operator"},"*"),s("te"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" maxId"),n("span",{class:"token punctuation"},";"),s(`

    te `),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("timeEventHead"),n("span",{class:"token punctuation"},";"),s(`
    maxId `),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("timeEventNextId"),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    monotime now `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getMonotonicUs"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// \u5FAA\u73AF\u76D1\u542C"),s(`
    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),s("te"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" id"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("te"),n("span",{class:"token operator"},"->"),s("id "),n("span",{class:"token operator"},"=="),s(" AE_DELETED_EVENT_ID"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u5220\u9664\u8BA1\u5212\u5220\u9664\u7684\u4E8B\u4EF6"),s(`
            aeTimeEvent `),n("span",{class:"token operator"},"*"),s("next "),n("span",{class:"token operator"},"="),s(" te"),n("span",{class:"token operator"},"->"),s("next"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token comment"},"// \u5982\u679C\u6B64\u8BA1\u65F6\u5668\u4E8B\u4EF6\u5B58\u5728\u5F15\u7528\uFF0C\u8BF7\u4E0D\u8981\u91CA\u653E\u5B83\u3002\u5F53\u524D\u4E3A\u9012\u5F52 timerProc \u8C03\u7528\u9012\u589E"),s(`
            `),n("span",{class:"token comment"},"// ..."),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("te"),n("span",{class:"token operator"},"->"),s("when "),n("span",{class:"token operator"},"<="),s(" now"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"int"),s(" retval"),n("span",{class:"token punctuation"},";"),s(`

            id `),n("span",{class:"token operator"},"="),s(" te"),n("span",{class:"token operator"},"->"),s("id"),n("span",{class:"token punctuation"},";"),s(`
            te`),n("span",{class:"token operator"},"->"),s("refcount"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
            retval `),n("span",{class:"token operator"},"="),s(" te"),n("span",{class:"token operator"},"->"),n("span",{class:"token function"},"timeProc"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token punctuation"},","),s(" id"),n("span",{class:"token punctuation"},","),s(" te"),n("span",{class:"token operator"},"->"),s("clientData"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
            te`),n("span",{class:"token operator"},"->"),s("refcount"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`
            processed`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
            now `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getMonotonicUs"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("retval "),n("span",{class:"token operator"},"!="),s(" AE_NOMORE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                te`),n("span",{class:"token operator"},"->"),s("when "),n("span",{class:"token operator"},"="),s(" now "),n("span",{class:"token operator"},"+"),s(" retval "),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"1000"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
                te`),n("span",{class:"token operator"},"->"),s("id "),n("span",{class:"token operator"},"="),s(" AE_DELETED_EVENT_ID"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        te `),n("span",{class:"token operator"},"="),s(" te"),n("span",{class:"token operator"},"->"),s("next"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" processed"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),D=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"aeApiState"),s(),n("span",{class:"token punctuation"},"{"),s(`
    fd_set rfds`),n("span",{class:"token punctuation"},","),s(" wfds"),n("span",{class:"token punctuation"},";"),s(`
    fd_set _rfds`),n("span",{class:"token punctuation"},","),s(" _wfds"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u6211\u4EEC\u9700\u8981\u4E00\u4EFD fd \u96C6\u7684\u526F\u672C\uFF0C\u56E0\u4E3A\u5728 select() \u4E4B\u540E\u91CD\u7528 FD \u96C6\u662F\u4E0D\u5B89\u5168\u7684\u3002"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" aeApiState"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"aeApiName"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},'"select"'),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeApiCreate"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeApiState `),n("span",{class:"token operator"},"*"),s("state "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zmalloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("aeApiState"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("state"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"FD_ZERO"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("rfds"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    `),n("span",{class:"token function"},"FD_ZERO"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("wfds"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    eventLoop`),n("span",{class:"token operator"},"->"),s("apidata "),n("span",{class:"token operator"},"="),s(" state"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeApiAddEvent"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" mask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeApiState `),n("span",{class:"token operator"},"*"),s("state "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("apidata"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_READABLE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token function"},"FD_SET"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("rfds"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_WRITABLE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token function"},"FD_SET"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("wfds"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"aeApiDelEvent"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" mask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeApiState `),n("span",{class:"token operator"},"*"),s("state "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("apidata"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_READABLE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token function"},"FD_CLR"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("rfds"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_WRITABLE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token function"},"FD_CLR"),n("span",{class:"token punctuation"},"("),s("fd"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("wfds"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeApiPoll"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"timeval"),s(),n("span",{class:"token operator"},"*"),s("tvp"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeApiState `),n("span",{class:"token operator"},"*"),s("state "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("apidata"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" retval"),n("span",{class:"token punctuation"},","),s(" j"),n("span",{class:"token punctuation"},","),s(" numevents "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("_rfds"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("rfds"),n("span",{class:"token punctuation"},","),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("fd_set"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"memcpy"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("_wfds"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("wfds"),n("span",{class:"token punctuation"},","),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("fd_set"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(` 

    retval `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"select"),n("span",{class:"token punctuation"},"("),s("eventLoop"),n("span",{class:"token operator"},"->"),s("maxfd"),n("span",{class:"token operator"},"+"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("_rfds"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("_wfds"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(" tvp"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("retval "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token comment"},"// \u904D\u5386\uFF0C\u5224\u65AD\u6709\u54EA\u4E9B\u4E8B\u4EF6\u6570\u636E\u51C6\u5907\u5B8C\u6210"),s(`
        `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("maxfd"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"int"),s(" mask "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
            aeFileEvent `),n("span",{class:"token operator"},"*"),s("fe "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"&"),s("eventLoop"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`

            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fe"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"=="),s(" AE_NONE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fe"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_READABLE "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"FD_ISSET"),n("span",{class:"token punctuation"},"("),s("j"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("_rfds"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
                mask `),n("span",{class:"token operator"},"|="),s(" AE_READABLE"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("fe"),n("span",{class:"token operator"},"->"),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_WRITABLE "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token function"},"FD_ISSET"),n("span",{class:"token punctuation"},"("),s("j"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("state"),n("span",{class:"token operator"},"->"),s("_wfds"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
                mask `),n("span",{class:"token operator"},"|="),s(" AE_WRITABLE"),n("span",{class:"token punctuation"},";"),s(`
            eventLoop`),n("span",{class:"token operator"},"->"),s("fired"),n("span",{class:"token punctuation"},"["),s("numevents"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("fd "),n("span",{class:"token operator"},"="),s(" j"),n("span",{class:"token punctuation"},";"),s(`
            eventLoop`),n("span",{class:"token operator"},"->"),s("fired"),n("span",{class:"token punctuation"},"["),s("numevents"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("mask "),n("span",{class:"token operator"},"="),s(" mask"),n("span",{class:"token punctuation"},";"),s(`
            numevents`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("retval "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"panic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"aeApiPoll: select, %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" numevents"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),B=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token keyword"},"typedef"),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"aeApiState"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" epfd"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"epoll_event"),s(),n("span",{class:"token operator"},"*"),s("events"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(" aeApiState"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"char"),s(),n("span",{class:"token operator"},"*"),n("span",{class:"token function"},"aeApiName"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token string"},'"epoll"'),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u521B\u5EFA"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeApiCreate"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeApiState `),n("span",{class:"token operator"},"*"),s("state "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zmalloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("aeApiState"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("state"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    state`),n("span",{class:"token operator"},"->"),s("events "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zmalloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"epoll_event"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token operator"},"->"),s("setsize"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("state"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"zfree"),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    state`),n("span",{class:"token operator"},"->"),s("epfd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"epoll_create"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"1024"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token operator"},"->"),s("epfd "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"zfree"),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"zfree"),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token function"},"anetCloexec"),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token operator"},"->"),s("epfd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    eventLoop`),n("span",{class:"token operator"},"->"),s("apidata "),n("span",{class:"token operator"},"="),s(" state"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// ..."),s(`

`),n("span",{class:"token comment"},"// \u6DFB\u52A0\u4E8B\u4EF6"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeApiAddEvent"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" mask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeApiState `),n("span",{class:"token operator"},"*"),s("state "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("apidata"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"epoll_event"),s(" ee "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(` 
    `),n("span",{class:"token comment"},"// \u5982\u679C fd \u5DF2\u7ECF\u88AB\u76D1\u89C6\u67D0\u4E9B\u4E8B\u4EF6\uFF0C\u6211\u4EEC\u9700\u8981\u4E00\u4E2A MOD \u64CD\u4F5C\u3002\u5426\u5219\u6211\u4EEC\u9700\u8981\u4E00\u4E2A ADD \u64CD\u4F5C\u3002"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" op "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},"["),s("fd"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("mask "),n("span",{class:"token operator"},"=="),s(" AE_NONE "),n("span",{class:"token operator"},"?"),s(`
            EPOLL_CTL_ADD `),n("span",{class:"token operator"},":"),s(" EPOLL_CTL_MOD"),n("span",{class:"token punctuation"},";"),s(`

    ee`),n("span",{class:"token punctuation"},"."),s("events "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    mask `),n("span",{class:"token operator"},"|="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},"["),s("fd"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("mask"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* Merge old events */"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_READABLE"),n("span",{class:"token punctuation"},")"),s(" ee"),n("span",{class:"token punctuation"},"."),s("events "),n("span",{class:"token operator"},"|="),s(" EPOLLIN"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_WRITABLE"),n("span",{class:"token punctuation"},")"),s(" ee"),n("span",{class:"token punctuation"},"."),s("events "),n("span",{class:"token operator"},"|="),s(" EPOLLOUT"),n("span",{class:"token punctuation"},";"),s(`
    ee`),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd "),n("span",{class:"token operator"},"="),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"epoll_ctl"),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token operator"},"->"),s("epfd"),n("span",{class:"token punctuation"},","),s("op"),n("span",{class:"token punctuation"},","),s("fd"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("ee"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u5220\u9664\u4E8B\u4EF6"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"aeApiDelEvent"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" fd"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" delmask"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeApiState `),n("span",{class:"token operator"},"*"),s("state "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("apidata"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"epoll_event"),s(" ee "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"/* avoid valgrind warning */"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" mask "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},"["),s("fd"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("mask "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"~"),s("delmask"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    ee`),n("span",{class:"token punctuation"},"."),s("events "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_READABLE"),n("span",{class:"token punctuation"},")"),s(" ee"),n("span",{class:"token punctuation"},"."),s("events "),n("span",{class:"token operator"},"|="),s(" EPOLLIN"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"&"),s(" AE_WRITABLE"),n("span",{class:"token punctuation"},")"),s(" ee"),n("span",{class:"token punctuation"},"."),s("events "),n("span",{class:"token operator"},"|="),s(" EPOLLOUT"),n("span",{class:"token punctuation"},";"),s(`
    ee`),n("span",{class:"token punctuation"},"."),s("data"),n("span",{class:"token punctuation"},"."),s("fd "),n("span",{class:"token operator"},"="),s(" fd"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("mask "),n("span",{class:"token operator"},"!="),s(" AE_NONE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"epoll_ctl"),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token operator"},"->"),s("epfd"),n("span",{class:"token punctuation"},","),s("EPOLL_CTL_MOD"),n("span",{class:"token punctuation"},","),s("fd"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("ee"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token comment"},"// Kernel < 2.6.9 \u9700\u8981\u4E00\u4E2A\u975E\u7A7A\u4E8B\u4EF6\u6307\u9488\uFF0C\u5373\u4F7F\u5BF9\u4E8E EPOLL_CTL_DEL\u3002"),s(`
        `),n("span",{class:"token function"},"epoll_ctl"),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token operator"},"->"),s("epfd"),n("span",{class:"token punctuation"},","),s("EPOLL_CTL_DEL"),n("span",{class:"token punctuation"},","),s("fd"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("ee"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(` 
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// IO \u591A\u8DEF\u590D\u7528"),s(`
`),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"aeApiPoll"),n("span",{class:"token punctuation"},"("),s("aeEventLoop "),n("span",{class:"token operator"},"*"),s("eventLoop"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"timeval"),s(),n("span",{class:"token operator"},"*"),s("tvp"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    aeApiState `),n("span",{class:"token operator"},"*"),s("state "),n("span",{class:"token operator"},"="),s(" eventLoop"),n("span",{class:"token operator"},"->"),s("apidata"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" retval"),n("span",{class:"token punctuation"},","),s(" numevents "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`

    retval `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"epoll_wait"),n("span",{class:"token punctuation"},"("),s("state"),n("span",{class:"token operator"},"->"),s("epfd"),n("span",{class:"token punctuation"},","),s(`
                        state`),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token punctuation"},","),s(`
                        eventLoop`),n("span",{class:"token operator"},"->"),s("setsize"),n("span",{class:"token punctuation"},","),s(`
                        tvp `),n("span",{class:"token operator"},"?"),s(),n("span",{class:"token punctuation"},"("),s("tvp"),n("span",{class:"token operator"},"->"),s("tv_sec"),n("span",{class:"token operator"},"*"),n("span",{class:"token number"},"1000"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token punctuation"},"("),s("tvp"),n("span",{class:"token operator"},"->"),s("tv_usec "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"999"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"/"),n("span",{class:"token number"},"1000"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},":"),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("retval "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"int"),s(" j"),n("span",{class:"token punctuation"},";"),s(`

        numevents `),n("span",{class:"token operator"},"="),s(" retval"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),s("j "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" j "),n("span",{class:"token operator"},"<"),s(" numevents"),n("span",{class:"token punctuation"},";"),s(" j"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"int"),s(" mask "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"epoll_event"),s(),n("span",{class:"token operator"},"*"),s("e "),n("span",{class:"token operator"},"="),s(" state"),n("span",{class:"token operator"},"->"),s("events"),n("span",{class:"token operator"},"+"),s("j"),n("span",{class:"token punctuation"},";"),s(`

            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("e"),n("span",{class:"token operator"},"->"),s("events "),n("span",{class:"token operator"},"&"),s(" EPOLLIN"),n("span",{class:"token punctuation"},")"),s(" mask "),n("span",{class:"token operator"},"|="),s(" AE_READABLE"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("e"),n("span",{class:"token operator"},"->"),s("events "),n("span",{class:"token operator"},"&"),s(" EPOLLOUT"),n("span",{class:"token punctuation"},")"),s(" mask "),n("span",{class:"token operator"},"|="),s(" AE_WRITABLE"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("e"),n("span",{class:"token operator"},"->"),s("events "),n("span",{class:"token operator"},"&"),s(" EPOLLERR"),n("span",{class:"token punctuation"},")"),s(" mask "),n("span",{class:"token operator"},"|="),s(" AE_WRITABLE"),n("span",{class:"token operator"},"|"),s("AE_READABLE"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("e"),n("span",{class:"token operator"},"->"),s("events "),n("span",{class:"token operator"},"&"),s(" EPOLLHUP"),n("span",{class:"token punctuation"},")"),s(" mask "),n("span",{class:"token operator"},"|="),s(" AE_WRITABLE"),n("span",{class:"token operator"},"|"),s("AE_READABLE"),n("span",{class:"token punctuation"},";"),s(`
            eventLoop`),n("span",{class:"token operator"},"->"),s("fired"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("fd "),n("span",{class:"token operator"},"="),s(" e"),n("span",{class:"token operator"},"->"),s("data"),n("span",{class:"token punctuation"},"."),s("fd"),n("span",{class:"token punctuation"},";"),s(`
            eventLoop`),n("span",{class:"token operator"},"->"),s("fired"),n("span",{class:"token punctuation"},"["),s("j"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},"."),s("mask "),n("span",{class:"token operator"},"="),s(" mask"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("retval "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token operator"},"-"),n("span",{class:"token number"},"1"),s(),n("span",{class:"token operator"},"&&"),s(" errno "),n("span",{class:"token operator"},"!="),s(" EINTR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"panic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"aeApiPoll: epoll_wait, %s"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token function"},"strerror"),n("span",{class:"token punctuation"},"("),s("errno"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" numevents"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),F=n("hr",null,null,-1),x=n("h2",{id:"_3-\u63A5\u6536\u8BF7\u6C42-\u8FD4\u56DE\u54CD\u5E94",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3-\u63A5\u6536\u8BF7\u6C42-\u8FD4\u56DE\u54CD\u5E94","aria-hidden":"true"},"#"),s(" 3. \u63A5\u6536\u8BF7\u6C42 & \u8FD4\u56DE\u54CD\u5E94")],-1),U=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u547D\u4EE4\u8BF7\u6C42\u5904\u7406\u5668\uFF0C\u8D1F\u8D23\u4ECE\u5957\u63A5\u5B57\u4E2D\u8BFB\u5165\u5BA2\u6237\u7AEF\u53D1\u9001\u7684\u547D\u4EE4\u8BF7\u6C42"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"readQueryFromClient"),n("span",{class:"token punctuation"},"("),s("connection "),n("span",{class:"token operator"},"*"),s("conn"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    client `),n("span",{class:"token operator"},"*"),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"connGetPrivateData"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" nread"),n("span",{class:"token punctuation"},","),s(" big_arg "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"size_t"),s(" qblen"),n("span",{class:"token punctuation"},","),s(" readlen"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// ..."),s(`

    readlen `),n("span",{class:"token operator"},"="),s(" PROTO_IOBUF_LEN"),n("span",{class:"token punctuation"},";"),s(`
    
    `),n("span",{class:"token comment"},"// ... \u7533\u8BF7\u5408\u9002\u7684\u7A7A\u95F4\u5B58\u653E\u6570\u636E"),s(`
    
    nread `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"connRead"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("conn"),n("span",{class:"token punctuation"},","),s(" c"),n("span",{class:"token operator"},"->"),s("querybuf"),n("span",{class:"token operator"},"+"),s("qblen"),n("span",{class:"token punctuation"},","),s(" readlen"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    
    `),n("span",{class:"token comment"},"// ... read \u5931\u8D25\u7684\u7279\u6B8A\u60C5\u51B5\u5904\u7406"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token comment"},"// \u5904\u7406\u7F13\u51B2\u533A\u8BFB\u5230\u7684\u6570\u636E"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"processInputBuffer"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(`
         c `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},";"),s(`

done`),n("span",{class:"token operator"},":"),s(`
    `),n("span",{class:"token function"},"beforeNextClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u4E3B\u7EBF\u7A0B\u5904\u7406 inputBuffer \u7684\u6570\u636E"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"processInputBuffer"),n("span",{class:"token punctuation"},"("),s("client "),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// \u8BFB\u53D6\u7F13\u51B2\u533A\u6240\u6709\u5185\u5BB9\uFF0C\u5E76\u89E3\u6790\u547D\u4EE4"),s(`
    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("qb_pos "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token function"},"sdslen"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("querybuf"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token comment"},"// ... \u7279\u6B8A\u60C5\u51B5\u53CA\u65F6 break"),s(`

        `),n("span",{class:"token comment"},"// \u786E\u5B9A \u547D\u4EE4\u8BF7\u6C42\u7C7B\u578B"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("c"),n("span",{class:"token operator"},"->"),s("reqtype"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("querybuf"),n("span",{class:"token punctuation"},"["),s("c"),n("span",{class:"token operator"},"->"),s("qb_pos"),n("span",{class:"token punctuation"},"]"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token char"},"'*'"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                c`),n("span",{class:"token operator"},"->"),s("reqtype "),n("span",{class:"token operator"},"="),s(" PROTO_REQ_MULTIBULK"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
                c`),n("span",{class:"token operator"},"->"),s("reqtype "),n("span",{class:"token operator"},"="),s(" PROTO_REQ_INLINE"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("reqtype "),n("span",{class:"token operator"},"=="),s(" PROTO_REQ_INLINE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"processInlineBuffer"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(" C_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 \u89E3\u6790 inline \u547D\u4EE4"),s(`
                `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("reqtype "),n("span",{class:"token operator"},"=="),s(" PROTO_REQ_MULTIBULK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"processMultibulkBuffer"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"!="),s(" C_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 \u89E3\u6790 \u6279\u5904\u7406 \u547D\u4EE4"),s(`
                `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"serverPanic"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"Unknown request type"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("argc "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"resetClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token comment"},"// \u5982\u679C\u6211\u4EEC\u5728\u4E00\u4E2A IO \u7EBF\u7A0B\u7684\u4E0A\u4E0B\u6587\u4E2D\uFF0C\u6211\u4EEC\u4E0D\u80FD\u771F\u6B63\u6267\u884C\u8FD9\u91CC\u7684\u547D\u4EE4\u3002\u6211\u4EEC\u6240\u80FD\u505A\u7684\u5C31\u662F\u5C06\u5BA2\u6237\u7AEF\u6807\u8BB0\u4E3A\u9700\u8981\u5904\u7406\u547D\u4EE4\u7684\u5BA2\u6237\u7AEF\u3002"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("io_threads_op "),n("span",{class:"token operator"},"!="),s(" IO_THREADS_OP_IDLE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token function"},"serverAssert"),n("span",{class:"token punctuation"},"("),s("io_threads_op "),n("span",{class:"token operator"},"=="),s(" IO_THREADS_OP_READ"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                c`),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"|="),s(" CLIENT_PENDING_COMMAND"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`

            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"processCommandAndResetClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 \u6267\u884C\u547D\u4EE4"),s(`
                `),n("span",{class:"token keyword"},"return"),s(" C_ERR"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// ... \u4E3B\u4ECE\u76F8\u5173\u5185\u5B58\u914D\u7F6E"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`
    
    `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},`/* \u8C03\u7528 processCommand() \u51FD\u6570\u5904\u7406\u547D\u4EE4\uFF0C\u540C\u65F6\u8FD8\u5305\u542B\u4EE5\u4E0B\u4EFB\u52A1\uFF1A
 *
 * 1. \u5C06\u5F53\u524D\u5BA2\u6237\u7AEF\u8BBE\u7F6E\u4E3A\u5BA2\u6237\u7AEF\u201Cc\u201D
 * 2. \u5982\u679C\u547D\u4EE4\u5DF2\u5904\u7406\uFF0C\u5219\u8C03\u7528 commandProcessed()
 */`),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"processCommandAndResetClient"),n("span",{class:"token punctuation"},"("),s("client "),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" deadclient "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    client `),n("span",{class:"token operator"},"*"),s("old_client "),n("span",{class:"token operator"},"="),s(" server"),n("span",{class:"token punctuation"},"."),s("current_client"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// \u5C06\u5F53\u524D\u5BA2\u6237\u7AEF\u8BBE\u7F6E\u4E3A\u5BA2\u6237\u7AEF\u201Cc\u201D"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("current_client "),n("span",{class:"token operator"},"="),s(" c"),n("span",{class:"token punctuation"},";"),s(`
    
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"processCommand"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" C_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
        `),n("span",{class:"token function"},"commandProcessed"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`

        `),n("span",{class:"token function"},"updateClientMemUsage"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u66F4\u65B0\u5BA2\u6237\u7AEF\u7684\u5185\u5B58\u4EE5\u5305\u62EC\u5904\u7406\u547D\u4EE4\u540E\u7684\u8F93\u51FA\u7F13\u51B2\u533A\u589E\u957F\u3002"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("current_client "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},")"),s(` 
        deadclient `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},";"),s(`
        
    server`),n("span",{class:"token punctuation"},"."),s("current_client "),n("span",{class:"token operator"},"="),s(" old_client"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u6062\u590D\u65E7\u5BA2\u6237\u7AEF"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" deadclient "),n("span",{class:"token operator"},"?"),s(" C_ERR "),n("span",{class:"token operator"},":"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(` 
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},`/* \u6267\u884C\u547D\u4EE4\u540E\u6267\u884C\u5FC5\u8981\u7684\u4EFB\u52A1\uFF1A 
 * 1. \u9664\u975E\u6709\u7406\u7531\u907F\u514D\u8FD9\u6837\u505A\uFF0C\u5426\u5219\u4F1A\u91CD\u7F6E\u5BA2\u6237\u7AEF\u3002 
 * 2. \u5728\u4E3B\u5BA2\u6237\u7AEF\u7684\u60C5\u51B5\u4E0B\uFF0C\u66F4\u65B0\u590D\u5236\u504F\u79FB\u91CF\u3002 
 * 3. \u5C06\u6211\u4EEC\u4ECE master \u83B7\u5F97\u7684\u547D\u4EE4\u4F20\u64AD\u5230\u4E0B\u7EBF\u7684\u526F\u672C
 */`),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"commandProcessed"),n("span",{class:"token punctuation"},"("),s("client "),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"&"),s(" CLIENT_BLOCKED"),n("span",{class:"token punctuation"},")"),s(` 
        `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5982\u679C\u5BA2\u6237\u7AEF\u88AB\u963B\u585E\uFF08\u5305\u62EC\u6682\u505C\uFF09\uFF0C\u53EA\u9700\u8FD4\u56DE\u907F\u514D\u91CD\u7F6E\u548C\u590D\u5236\u3002 "),s(`

    `),n("span",{class:"token function"},"resetClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`

    `),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" prev_offset "),n("span",{class:"token operator"},"="),s(" c"),n("span",{class:"token operator"},"->"),s("reploff"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token comment"},"// ... \u4E3B\u4ECE\u76F8\u5173\u5185\u5B58\u914D\u7F6E"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),M=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u547D\u4EE4\u56DE\u590D\u5904\u7406\u5668\uFF0C\u8D1F\u8D23\u5C06\u670D\u52A1\u7AEF\u6267\u884C\u547D\u4EE4\u540E\u7684\u547D\u4EE4\u56DE\u590D \u901A\u8FC7 socket \u8FD4\u56DE\u7ED9\u5BA2\u6237\u7AEF"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"sendReplyToClient"),n("span",{class:"token punctuation"},"("),s("connection "),n("span",{class:"token operator"},"*"),s("conn"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},","),n("span",{class:"token punctuation"},"{"),s(`
    client `),n("span",{class:"token operator"},"*"),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"connGetPrivateData"),n("span",{class:"token punctuation"},"("),s("conn"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"writeToClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},`/* \u5C06\u8F93\u51FA\u7F13\u51B2\u533A\u4E2D\u7684\u6570\u636E\u5199\u5165\u5BA2\u6237\u7AEF\u3002
 * \u5982\u679C\u5BA2\u6237\u7AEF\u5728\u8C03\u7528\u540E\u4ECD\u7136\u6709\u6548\uFF0C\u5219\u8FD4\u56DE C_OK\uFF0C
 * \u5982\u679C\u7531\u4E8E\u67D0\u4E9B\u9519\u8BEF\u800C\u88AB\u91CA\u653E\uFF0C\u5219\u8FD4\u56DE C_ERR\u3002
 * 
 * \u5982\u679C\u8BBE\u7F6E\u4E86 handler_installed\uFF0C\u5B83\u5C06\u5C1D\u8BD5\u6E05\u9664\u5199\u5165\u4E8B\u4EF6\u3002\u6B64\u51FD\u6570\u7531\u7EBF\u7A0B\u8C03\u7528\uFF0C\u4F46\u59CB\u7EC8\u5C06 handler_installed \u8BBE\u7F6E\u4E3A 0\u3002
 * \u56E0\u6B64\uFF0C\u5F53 handler_installed \u8BBE\u7F6E\u4E3A 0 \u65F6\uFF0C\u8BE5\u51FD\u6570\u5FC5\u987B\u662F\u7EBF\u7A0B\u5B89\u5168\u7684\u3002
 */`),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"writeToClient"),n("span",{class:"token punctuation"},"("),s("client "),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" handler_installed"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token function"},"atomicIncr"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("stat_total_writes_processed"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u66F4\u65B0\u670D\u52A1\u5668\u4E0A\u7684\u5199\u5165\u603B\u6570"),s(`

    `),n("span",{class:"token class-name"},"ssize_t"),s(" nwritten "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},","),s(" totwritten "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"clientHasPendingReplies"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"int"),s(" ret "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"_writeToClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("nwritten"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ret "),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
        totwritten `),n("span",{class:"token operator"},"+="),s(" nwritten"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("totwritten "),n("span",{class:"token operator"},">"),s(" NET_MAX_WRITES_PER_EVENT "),n("span",{class:"token operator"},"&&"),s(`
            `),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("maxmemory "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),s(),n("span",{class:"token operator"},"||"),s(`
             `),n("span",{class:"token function"},"zmalloc_used_memory"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"<"),s(" server"),n("span",{class:"token punctuation"},"."),s("maxmemory"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"&&"),s(`
            `),n("span",{class:"token operator"},"!"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"&"),s(" CLIENT_SLAVE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(` 
                `),n("span",{class:"token keyword"},"break"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// ... \u4E3B\u4ECE & \u96C6\u7FA4\u76F8\u5173\u914D\u7F6E"),s(`
    
    `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u8BE5\u51FD\u6570\u5BF9\u4E0D\u540C\u7C7B\u578B\u7684\u5BA2\u6237\u7AEF\u5B9E\u9645\u5199\u5165\u8F93\u51FA\u7F13\u51B2\u533A\uFF0C\u7531 writeToClient \u8C03\u7528\u3002"),s(`
`),n("span",{class:"token comment"},"// \u5982\u679C\u5199\u5165\u6210\u529F\uFF0C\u5219\u8FD4\u56DE C_OK\uFF0C\u5426\u5219\u8FD4\u56DE C_ERR\uFF0C'nwritten' \u4E3A\u8F93\u51FA\u53C2\u6570\uFF0C\u8868\u793A\u670D\u52A1\u5668\u5199\u5165\u5BA2\u6237\u7AEF\u7684\u5B57\u8282\u6570\u3002"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"_writeToClient"),n("span",{class:"token punctuation"},"("),s("client "),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"ssize_t"),s(),n("span",{class:"token operator"},"*"),s("nwritten"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token operator"},"*"),s("nwritten "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"getClientType"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" CLIENT_TYPE_SLAVE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token comment"},"// ..."),s(`
        
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("o"),n("span",{class:"token operator"},"->"),s("used "),n("span",{class:"token operator"},">"),s(" c"),n("span",{class:"token operator"},"->"),s("ref_block_pos"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token operator"},"*"),s("nwritten "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"connWrite"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("conn"),n("span",{class:"token punctuation"},","),s(` 
                                  o`),n("span",{class:"token operator"},"->"),s("buf"),n("span",{class:"token operator"},"+"),s("c"),n("span",{class:"token operator"},"->"),s("ref_block_pos"),n("span",{class:"token punctuation"},","),s(`
                                  o`),n("span",{class:"token operator"},"->"),s("used"),n("span",{class:"token operator"},"-"),s("c"),n("span",{class:"token operator"},"->"),s("ref_block_pos"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 "),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("nwritten "),n("span",{class:"token operator"},"<="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(" C_ERR"),n("span",{class:"token punctuation"},";"),s(`
            c`),n("span",{class:"token operator"},"->"),s("ref_block_pos "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token operator"},"*"),s("nwritten"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

        `),n("span",{class:"token comment"},"// ..."),s(`
        
        `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// \u5F53\u56DE\u590D\u5217\u8868\u4E0D\u4E3A\u7A7A\u65F6\uFF0C\u6700\u597D\u4F7F\u7528 writev \u6765\u4E3A\u6211\u4EEC\u8282\u7701\u4E00\u4E9B\u7CFB\u7EDF\u8C03\u7528\u548C TCP \u6570\u636E\u5305\u3002"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listLength"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("reply"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(` 
        `),n("span",{class:"token keyword"},"int"),s(" ret "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"_writevToClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s(" nwritten"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606 \u8C03\u7528 connWritev(c->conn, iov, iovcnt);"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ret "),n("span",{class:"token operator"},"!="),s(" C_OK"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(" ret"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listLength"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("reply"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u5982\u679C\u5217\u8868\u4E2D\u4E0D\u518D\u6709\u5BF9\u8C61\uFF0C\u6211\u4EEC\u671F\u671B\u56DE\u590D\u5B57\u8282\u6570\u6B63\u597D\u4E3A\u96F6\u3002"),s(`
            `),n("span",{class:"token function"},"serverAssert"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("reply_bytes "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("bufpos "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token operator"},"*"),s("nwritten "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"connWrite"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("conn"),n("span",{class:"token punctuation"},","),s(" c"),n("span",{class:"token operator"},"->"),s("buf "),n("span",{class:"token operator"},"+"),s(" c"),n("span",{class:"token operator"},"->"),s("sentlen"),n("span",{class:"token punctuation"},","),s(" c"),n("span",{class:"token operator"},"->"),s("bufpos "),n("span",{class:"token operator"},"-"),s(" c"),n("span",{class:"token operator"},"->"),s("sentlen"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"*"),s("nwritten "),n("span",{class:"token operator"},"<="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"return"),s(" C_ERR"),n("span",{class:"token punctuation"},";"),s(`
        c`),n("span",{class:"token operator"},"->"),s("sentlen "),n("span",{class:"token operator"},"+="),s(),n("span",{class:"token operator"},"*"),s("nwritten"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token comment"},"// ..."),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token comment"},"// \u8FD9\u4E2A\u51FD\u6570\u5728\u8FDB\u5165\u4E8B\u4EF6\u5FAA\u73AF\u4E4B\u524D\u88AB\u8C03\u7528\uFF0C\u5E0C\u671B\u6211\u4EEC\u53EF\u4EE5\u5C06\u56DE\u590D\u5199\u5165\u5BA2\u6237\u7AEF\u8F93\u51FA\u7F13\u51B2\u533A\uFF0C\u800C\u4E0D\u9700\u8981\u4F7F\u7528\u7CFB\u7EDF\u8C03\u7528\u6765\u5B89\u88C5\u53EF\u5199\u4E8B\u4EF6\u5904\u7406\u7A0B\u5E8F\uFF0C\u8C03\u7528\u5B83\u7B49\u7B49\u3002"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"handleClientsWithPendingWrites"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"void"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    listIter li`),n("span",{class:"token punctuation"},";"),s(`
    listNode `),n("span",{class:"token operator"},"*"),s("ln"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" processed "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"listLength"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("clients_pending_write"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token function"},"listRewind"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("clients_pending_write"),n("span",{class:"token punctuation"},","),n("span",{class:"token operator"},"&"),s("li"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"while"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),s("ln "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"listNext"),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"&"),s("li"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        client `),n("span",{class:"token operator"},"*"),s("c "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"listNodeValue"),n("span",{class:"token punctuation"},"("),s("ln"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        c`),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"&="),s(),n("span",{class:"token operator"},"~"),s("CLIENT_PENDING_WRITE"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"listDelNode"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("clients_pending_write"),n("span",{class:"token punctuation"},","),s("ln"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"&"),s(" CLIENT_PROTECTED"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5982\u679C\u5BA2\u6237\u7AEF\u53D7\u5230\u4FDD\u62A4\uFF0C\u8BF7\u4E0D\u8981\u505A\u4EFB\u4F55\u4E8B\u60C5\uFF0C\u8FD9\u53EF\u80FD\u4F1A\u89E6\u53D1\u5199\u5165\u9519\u8BEF\u6216\u91CD\u65B0\u521B\u5EFA\u5904\u7406\u7A0B\u5E8F\u3002"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"&"),s(" CLIENT_CLOSE_ASAP"),n("span",{class:"token punctuation"},")"),s(` 
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u4E0D\u8981\u5199\u4FE1\u65E0\u8BBA\u5982\u4F55\u5C06\u8981\u5173\u95ED\u7684\u5BA2\u6237\u3002"),s(`

        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"writeToClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=="),s(" C_ERR"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
            `),n("span",{class:"token keyword"},"continue"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5C1D\u8BD5\u5C06\u7F13\u51B2\u533A\u5199\u5165\u5BA2\u6237\u7AEF\u5957\u63A5\u5B57\u3002"),s(`

        `),n("span",{class:"token comment"},"// \u5982\u679C\u5728\u4E0A\u9762\u7684\u540C\u6B65\u5199\u5165\u4E4B\u540E\u6211\u4EEC\u4ECD\u7136\u6709\u6570\u636E\u8981\u8F93\u51FA\u5230\u5BA2\u6237\u7AEF\uFF0C\u6211\u4EEC\u9700\u8981\u5B89\u88C5 \u53EF\u5199\u5904\u7406\u7A0B\u5E8F\u3002"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"clientHasPendingReplies"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token function"},"installClientWriteHandler"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" processed"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`

`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),z=n("hr",null,null,-1),j=n("h2",{id:"_4-\u5904\u7406\u547D\u4EE4",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_4-\u5904\u7406\u547D\u4EE4","aria-hidden":"true"},"#"),s(" 4. \u5904\u7406\u547D\u4EE4")],-1),G=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u5904\u7406\u547D\u4EE4"),s(`
`),n("span",{class:"token comment"},"// \u5982\u679C\u8FD4\u56DE C_OK\uFF0C\u5219\u5BA2\u6237\u7AEF\u4ECD\u7136\u6D3B\u7740\u4E14\u6709\u6548\uFF0C\u8C03\u7528\u8005\u53EF\u4EE5\u6267\u884C\u5176\u4ED6\u64CD\u4F5C\u3002\u5426\u5219\uFF0C\u5982\u679C\u8FD4\u56DE C_ERR\uFF0C\u5219\u5BA2\u6237\u7AEF\u88AB\u9500\u6BC1\uFF08\u5373\u5728 QUIT \u4E4B\u540E\uFF09\u3002"),s(`
`),n("span",{class:"token keyword"},"int"),s(),n("span",{class:"token function"},"processCommand"),n("span",{class:"token punctuation"},"("),s("client "),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token comment"},"// ... \u9884\u5904\u7406"),s(`

    `),n("span",{class:"token comment"},"// \u67E5\u627E\u547D\u4EE4\uFF0C\u68C0\u67E5\u662F\u5426\u6709\u9519\u8BEF"),s(`
    c`),n("span",{class:"token operator"},"->"),s("cmd "),n("span",{class:"token operator"},"="),s(" c"),n("span",{class:"token operator"},"->"),s("lastcmd "),n("span",{class:"token operator"},"="),s(" c"),n("span",{class:"token operator"},"->"),s("realcmd "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"lookupCommand"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("argv"),n("span",{class:"token punctuation"},","),s("c"),n("span",{class:"token operator"},"->"),s("argc"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u2606\u2606\u2606"),s(`
    sds err`),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"commandCheckExistence"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("err"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"rejectCommandSds"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s(" err"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u6709\u9519\u8BEF\uFF0C\u62D2\u7EDD\u6267\u884C\uFF0C\u8FD4\u56DE"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),n("span",{class:"token function"},"commandCheckArity"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"&"),s("err"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"rejectCommandSds"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s(" err"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token comment"},"// ... \u68C0\u67E5\u547D\u4EE4\u662F\u5426\u88AB\u6807\u8BB0\u4E3A\u53D7\u4FDD\u62A4\u5E76\u4E14\u76F8\u5173\u914D\u7F6E\u662F\u5426\u5141\u8BB8"),s(`

    `),n("span",{class:"token class-name"},"uint64_t"),s(" cmd_flags "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"getCommandFlags"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"int"),s(" is_read_command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_READONLY"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
                           `),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"=="),s(" execCommand "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_READONLY"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" is_write_command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_WRITE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
                           `),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"=="),s(" execCommand "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_WRITE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" is_denyoom_command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_DENYOOM"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
                             `),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"=="),s(" execCommand "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_DENYOOM"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" is_denystale_command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"!"),n("span",{class:"token punctuation"},"("),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_STALE"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
                               `),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"=="),s(" execCommand "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("cmd_inv_flags "),n("span",{class:"token operator"},"&"),s(" CMD_STALE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" is_denyloading_command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token operator"},"!"),n("span",{class:"token punctuation"},"("),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_LOADING"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
                                 `),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"=="),s(" execCommand "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("cmd_inv_flags "),n("span",{class:"token operator"},"&"),s(" CMD_LOADING"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" is_may_replicate_command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token punctuation"},"("),s("CMD_WRITE "),n("span",{class:"token operator"},"|"),s(" CMD_MAY_REPLICATE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
                                   `),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"=="),s(" execCommand "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token punctuation"},"("),s("CMD_WRITE "),n("span",{class:"token operator"},"|"),s(" CMD_MAY_REPLICATE"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" is_deny_async_loading_command "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_NO_ASYNC_LOADING"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"||"),s(`
                                        `),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"=="),s(" execCommand "),n("span",{class:"token operator"},"&&"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("cmd_flags "),n("span",{class:"token operator"},"&"),s(" CMD_NO_ASYNC_LOADING"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"int"),s(" obey_client "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"mustObeyClient"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// ... \u547D\u4EE4\u7684\u6743\u9650\u8BA4\u8BC1\u3001\u96C6\u7FA4\u76F8\u5173\u914D\u7F6E\u3001\u786E\u4FDD\u5185\u5B58\u8DB3\u591F\u3001\u4E3B\u4ECE\u76F8\u5173\u914D\u7F6E\u7B49"),s(`

    `),n("span",{class:"token comment"},"// \u6267\u884C\u547D\u4EE4"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"&"),s(" CLIENT_MULTI "),n("span",{class:"token operator"},"&&"),s(`
        c`),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"!="),s(" execCommand "),n("span",{class:"token operator"},"&&"),s(`
        c`),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"!="),s(" discardCommand "),n("span",{class:"token operator"},"&&"),s(`
        c`),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"!="),s(" multiCommand "),n("span",{class:"token operator"},"&&"),s(`
        c`),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"!="),s(" watchCommand "),n("span",{class:"token operator"},"&&"),s(`
        c`),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"!="),s(" quitCommand "),n("span",{class:"token operator"},"&&"),s(`
        c`),n("span",{class:"token operator"},"->"),s("cmd"),n("span",{class:"token operator"},"->"),s("proc "),n("span",{class:"token operator"},"!="),s(" resetCommand"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"queueMultiCommand"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s(" cmd_flags"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token function"},"addReply"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s("shared"),n("span",{class:"token punctuation"},"."),s("queued"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"else"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"call"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},","),s("CMD_CALL_FULL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        c`),n("span",{class:"token operator"},"->"),s("woff "),n("span",{class:"token operator"},"="),s(" server"),n("span",{class:"token punctuation"},"."),s("master_repl_offset"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token function"},"listLength"),n("span",{class:"token punctuation"},"("),s("server"),n("span",{class:"token punctuation"},"."),s("ready_keys"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token function"},"handleClientsBlockedOnKeys"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" C_OK"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),W={href:"https://github.com/redis/redis/blob/7.0/src/multi.c",target:"_blank",rel:"noopener noreferrer"},K=s("\u6E90\u7801\u5730\u5740"),V=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},"// \u5C06\u65B0\u547D\u4EE4\u6DFB\u52A0\u5230 MULTI \u547D\u4EE4\u961F\u5217"),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"queueMultiCommand"),n("span",{class:"token punctuation"},"("),s("client "),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"uint64_t"),s(" cmd_flags"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    multiCmd `),n("span",{class:"token operator"},"*"),s("mc"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token punctuation"},"("),s("CLIENT_DIRTY_CAS"),n("span",{class:"token operator"},"|"),s("CLIENT_DIRTY_EXEC"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
        `),n("span",{class:"token keyword"},"return"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5982\u679C\u4E8B\u52A1\u5DF2\u7ECF\u4E2D\u6B62\uFF0C\u53CA\u65F6\u8FD4\u56DE"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("count "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token comment"},"// \u5982\u679C\u5BA2\u6237\u7AEF\u4F7F\u7528 multiexec\uFF0C\u5047\u8BBE\u5B83\u7528\u4E8E\u6267\u884C\u81F3\u5C11\u4E24\u4E2A\u547D\u4EE4\u3002\u56E0\u6B64\uFF0C\u9ED8\u8BA4\u521B\u5EFA\u5927\u5C0F\u4E3A 2\u3002"),s(`
        c`),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("commands "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zmalloc"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("multiCmd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"*"),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        c`),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("alloc_count "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"2"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("count "),n("span",{class:"token operator"},"=="),s(" c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("alloc_count"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        c`),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("alloc_count "),n("span",{class:"token operator"},"="),s(" c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("alloc_count "),n("span",{class:"token operator"},"<"),s(" INT_MAX"),n("span",{class:"token operator"},"/"),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},"?"),s(" c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("alloc_count"),n("span",{class:"token operator"},"*"),n("span",{class:"token number"},"2"),s(),n("span",{class:"token operator"},":"),s(" INT_MAX"),n("span",{class:"token punctuation"},";"),s(`
        c`),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("commands "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"zrealloc"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("commands"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"sizeof"),n("span",{class:"token punctuation"},"("),s("multiCmd"),n("span",{class:"token punctuation"},")"),n("span",{class:"token operator"},"*"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token operator"},"->"),s("mstate"),n("span",{class:"token punctuation"},"."),s("alloc_count"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    
    `),n("span",{class:"token comment"},"// ... \u76F8\u5173\u53C2\u6570\u8BBE\u7F6E"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),H=n("div",{class:"language-c ext-c line-numbers-mode"},[n("pre",{class:"language-c"},[n("code",null,[n("span",{class:"token comment"},`/* call() \u662F Redis \u6267\u884C\u547D\u4EE4\u7684\u6838\u5FC3\u3002
 *
 * \u53EF\u4EE5\u4F20\u9012\u4EE5\u4E0B\u6807\u5FD7\uFF1A
 * CMD_CALL_NONE        No flags.
 * CMD_CALL_SLOWLOG     \u68C0\u67E5\u547D\u4EE4\u901F\u5EA6\u5E76\u5728\u9700\u8981\u65F6\u767B\u5F55\u6162\u65E5\u5FD7\u3002
 * CMD_CALL_STATS       \u586B\u5145\u547D\u4EE4\u7EDF\u8BA1\u4FE1\u606F\u3002
 * CMD_CALL_PROPAGATE_AOF   \u5982\u679C AOF \u4FEE\u6539\u4E86\u6570\u636E\u96C6\u6216\u5BA2\u6237\u7AEF\u6807\u5FD7\u5F3A\u5236\u4F20\u64AD\uFF0C\u5219\u5C06\u547D\u4EE4\u9644\u52A0\u5230 AOF\u3002
 * CMD_CALL_PROPAGATE_REPL  \u5982\u679C\u5B83\u4FEE\u6539\u4E86\u6570\u636E\u96C6\u6216\u8005\u5BA2\u6237\u7AEF\u6807\u5FD7\u5F3A\u5236\u4F20\u64AD\uFF0C\u5219\u5411 slave \u53D1\u9001\u547D\u4EE4\u3002
 * CMD_CALL_PROPAGATE   PROPAGATE_AOF|PROPAGATE_REPL \u522B\u540D
 * CMD_CALL_FULL        SLOWLOG|STATS|PROPAGATE \u522B\u540D
 *
 * \u786E\u5207\u7684\u4F20\u64AD\u884C\u4E3A\u53D6\u51B3\u4E8E\u5BA2\u6237\u7AEF\u6807\u5FD7\u3002\u5177\u4F53\u6765\u8BF4\uFF1A
 * 1. \u5982\u679C\u8BBE\u7F6E\u4E86\u5BA2\u6237\u7AEF\u6807\u5FD7 CLIENT_FORCE_AOF | CLIENT_FORCE_REPL \u5E76\u5047\u8BBE\u5728\u8C03\u7528\u6807\u5FD7\u4E2D\u8BBE\u7F6E\u4E86\u76F8\u5E94\u7684 CMD_CALL_PROPAGATE_AOFREPL\uFF0C
 *    \u5219\u5373\u4F7F\u6570\u636E\u96C6\u4E0D\u53D7\u547D\u4EE4\u5F71\u54CD\uFF0C\u4E5F\u4F1A\u4F20\u64AD\u547D\u4EE4\u3002
 * 2. \u5982\u679C\u8BBE\u7F6E\u4E86\u5BA2\u6237\u7AEF\u6807\u5FD7 CLIENT_PREVENT_REPL_PROP \u6216 CLIENT_PREVENT_AOF_PROP\uFF0C
 *    \u5219\u5373\u4F7F\u547D\u4EE4\u4FEE\u6539\u4E86\u6570\u636E\u96C6\uFF0C\u4E5F\u4E0D\u4F1A\u6267\u884C\u5230 AOF \u6216\u4ECE\u5C5E\u8BBE\u5907\u7684\u4F20\u64AD\u3002
 *
 * \u8BF7\u6CE8\u610F\uFF0C\u65E0\u8BBA\u5BA2\u6237\u7AEF\u6807\u5FD7\u5982\u4F55\uFF0C\u5982\u679C CMD_CALL_PROPAGATE_AOF \u6216 CMD_CALL_PROPAGATE_REPL \u672A\u8BBE\u7F6E\uFF0C\u5219\u5206\u522B\u4E0D\u4F1A\u53D1\u751F AOF \u6216 \u4ECE\u5C5E\u4F20\u64AD\u3002
 *
 * \u5BA2\u6237\u7AEF\u6807\u5FD7\u901A\u8FC7\u4F7F\u7528\u4EE5\u4E0B API \u7684\u7ED9\u5B9A\u547D\u4EE4\u7684\u5B9E\u73B0\u6765\u4FEE\u6539\uFF1A
 * forceCommandPropagation(client *c, int flags);
 * preventCommandPropagation(client *c);
 * preventCommandAOF(client *c);
 * preventCommandReplication(client *c);
 */`),s(`
`),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"call"),n("span",{class:"token punctuation"},"("),s("client "),n("span",{class:"token operator"},"*"),s("c"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"int"),s(" flags"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" dirty"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token class-name"},"uint64_t"),s(" client_old_flags "),n("span",{class:"token operator"},"="),s(" c"),n("span",{class:"token operator"},"->"),s("flags"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"struct"),s(),n("span",{class:"token class-name"},"redisCommand"),s(),n("span",{class:"token operator"},"*"),s("real_cmd "),n("span",{class:"token operator"},"="),s(" c"),n("span",{class:"token operator"},"->"),s("realcmd"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// ... \u786E\u5B9A server \u4F20\u64AD\u884C\u4E3A\u7B49"),s(`

    `),n("span",{class:"token comment"},"// \u8C03\u7528\u547D\u4EE4\u3002"),s(`
    dirty `),n("span",{class:"token operator"},"="),s(" server"),n("span",{class:"token punctuation"},"."),s("dirty"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token function"},"incrCommandStatsOnError"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"NULL"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token keyword"},"long"),s(),n("span",{class:"token keyword"},"long"),s(" call_timer "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"ustime"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// ..."),s(`
    `),n("span",{class:"token comment"},"// ... \u66F4\u65B0\u5931\u8D25\u7684\u547D\u4EE4\u8C03\u7528"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token comment"},"// ... \u586B\u5145\u76F8\u5173\u7EDF\u8BA1\u4FE1\u606F"),s(`

    `),n("span",{class:"token comment"},"// \u5C06\u547D\u4EE4\u4F20\u64AD\u5230 AOF \u548C\u590D\u5236\u94FE\u63A5\u3002"),s(`
    `),n("span",{class:"token comment"},"// \u6211\u4EEC\u4ECE\u4E0D\u663E\u5F0F\u4F20\u64AD EXEC\uFF0C\u5982\u679C\u9700\u8981\uFF0C\u5B83\u5C06\u88AB\u9690\u5F0F\u4F20\u64AD\uFF08\u8BF7\u53C2\u9605propagatePendingCommands\uFF09\u3002"),s(`
    `),n("span",{class:"token comment"},"// \u6B64\u5916\uFF0C\u6A21\u5757\u547D\u4EE4\u4F1A\u81EA\u884C\u5904\u7406"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    `),n("span",{class:"token comment"},"// \u6062\u590D\u65E7\u7684\u590D\u5236\u6807\u5FD7\uFF0C\u56E0\u4E3A call() \u53EF\u4EE5\u9012\u5F52\u6267\u884C\u3002"),s(`
    c`),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"&="),s(),n("span",{class:"token operator"},"~"),n("span",{class:"token punctuation"},"("),s("CLIENT_FORCE_AOF"),n("span",{class:"token operator"},"|"),s("CLIENT_FORCE_REPL"),n("span",{class:"token operator"},"|"),s("CLIENT_PREVENT_PROP"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    c`),n("span",{class:"token operator"},"->"),s("flags "),n("span",{class:"token operator"},"|="),s(" client_old_flags "),n("span",{class:"token operator"},"&"),s(),n("span",{class:"token punctuation"},"("),s("CLIENT_FORCE_AOF"),n("span",{class:"token operator"},"|"),s("CLIENT_FORCE_REPL"),n("span",{class:"token operator"},"|"),s("CLIENT_PREVENT_PROP"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// \u5982\u679C\u5BA2\u6237\u7AEF\u4E3A\u5BA2\u6237\u7AEF\u7F13\u5B58\u542F\u7528\u4E86\u5BC6\u94A5\u8DDF\u8E2A\uFF0C\u8BF7\u786E\u4FDD\u8BB0\u4F4F\u5B83\u901A\u8FC7\u6B64\u547D\u4EE4\u83B7\u53D6\u7684\u5BC6\u94A5\u3002"),s(`
    `),n("span",{class:"token comment"},"// \u811A\u672C\u7684\u5DE5\u4F5C\u65B9\u5F0F\u7565\u6709\u4E0D\u540C\uFF0C\u5982\u679C\u811A\u672C\u6267\u884C\u4EFB\u4F55\u8BFB\u53D6\u547D\u4EE4\uFF0C\u5B83\u4F1A\u8BB0\u4F4F\u811A\u672C\u4E2D\u6240\u6709\u58F0\u660E\u7684\u952E\u3002"),s(`
    `),n("span",{class:"token comment"},"// ..."),s(`

    server`),n("span",{class:"token punctuation"},"."),s("fixed_time_expire"),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("stat_numcommands"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token comment"},"// ... \u76F8\u5173\u8BB0\u5F55\u64CD\u4F5C"),s(`

    `),n("span",{class:"token function"},"afterCommand"),n("span",{class:"token punctuation"},"("),s("c"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u505A\u4E00\u4E9B\u7EF4\u62A4\u5DE5\u4F5C\u548C\u6E05\u7406\u5DE5\u4F5C"),s(`

    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("server"),n("span",{class:"token punctuation"},"."),s("in_exec "),n("span",{class:"token operator"},"&&"),s(" server"),n("span",{class:"token punctuation"},"."),s("client_pause_in_transaction"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        server`),n("span",{class:"token punctuation"},"."),s("client_pause_in_transaction "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(),n("span",{class:"token comment"},"// \u5BA2\u6237\u7AEF\u6682\u505C\u5728\u4E8B\u52A1\u5B8C\u6210\u540E\u751F\u6548\u3002\u8FD9\u9700\u8981\u5728\u4F20\u64AD\u5B8C\u6240\u6709\u5185\u5BB9\u4E4B\u540E\u5B9A\u4F4D\u3002"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    server`),n("span",{class:"token punctuation"},"."),s("core_propagates "),n("span",{class:"token operator"},"="),s(" prev_core_propagates"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1);function q(Y,Z){const p=u("ExternalLinkIcon"),k=u("Mermaid"),l=u("Tabs");return d(),m("div",null,[b,n("p",null,[n("a",f,[_,c(p)])]),y,c(k,{id:"mermaid-1a962851",code:"sequenceDiagram%0A%20%20%20%20participant%20ser%20as%20server%0A%20%20%20%20participant%20ae%20as%20aeEventLoop%0A%20%20%20%20participant%20net%20as%20networking%0A%20%20%20%20participant%20anet%20%0A%20%20%20%20%0A%20%20%20%20ser%20-%3E%3E%2B%20ser%3A%20initServerConfig%0A%20%20%20%20ser%20-%3E%3E%2B%20ae%3A%20aeCreateEventLoop%20%E5%88%9B%E5%BB%BA%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6%0A%20%20%20%20ser%20-%3E%3E%2B%20anet%3A%20Server%20%E6%89%93%E5%BC%80%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3%20listen%0A%20%20%20%20ser%20-%3E%3E%2B%20ae%3A%20aeCreateTimeEvent%20%E6%B3%A8%E5%86%8C%20timer%20%E4%BA%8B%E4%BB%B6%0A%20%20%20%20ser%20-%3E%3E%2B%20ae%3A%20aeCreateFileEvent%20%E6%B3%A8%E5%86%8C%20file%20%E4%BA%8B%E4%BB%B6%EF%BC%8CIO%20%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%0A%20%20%20%20ser%20-%3E%3E%2B%20net%3A%20%E8%BF%9E%E6%8E%A5%E5%BA%94%E7%AD%94%E5%A4%84%E7%90%86%E5%99%A8%20acceptTcpHandler%0A%20%20%20%20net%20-%3E%3E%2B%20anet%3A%20Server%20%E6%89%A7%E8%A1%8C%20accpet%0A%20%20%20%20ser%20-%3E%3E%2B%20ser%3A%20bioInit%20%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%0A%20%20%20%20ser%20-%3E%3E%2B%20ae%3A%20aeMain%20%E5%90%AF%E5%8A%A8%E8%AF%A5%E4%BA%8B%E5%8A%A1%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6%0A%20%20%20%20net%20-%3E%3E%2B%20net%3A%20%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E5%99%A8%20readQueryFromClient%EF%BC%8C%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%0A%20%20%20%20net%20-%3E%3E%2B%20ser%3A%20%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%20processCommand%0A%20%20%20%20net%20-%3E%3E%2B%20net%3A%20%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D%E5%A4%84%E7%90%86%E5%99%A8%20sendReplyToClient%EF%BC%8C%E5%8F%91%E9%80%81%E5%9B%9E%E5%A4%8D%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%0A%20%20%20%20ae%20-%3E%3E%2B%20ae%3A%20aeDeleteEventLoop%20%E5%88%A0%E9%99%A4%E4%BA%8B%E5%8A%A1%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6%20%0A"}),E,c(l,{data:[{title:"initServerConfig"},{title:"initServer"},{title:"networking"},{title:"anet"},{title:"serverCron"},{title:"InitServerLast"},{title:"bioInit"}],"tab-id":"code1"},{tab0:a(({title:t,value:e,isActive:o})=>[w]),tab1:a(({title:t,value:e,isActive:o})=>[A]),tab2:a(({title:t,value:e,isActive:o})=>[n("ul",null,[n("li",null,[n("a",L,[g,c(p)])])]),C]),tab3:a(({title:t,value:e,isActive:o})=>[n("ul",null,[n("li",null,[n("a",R,[h,c(p)])])]),T]),tab4:a(({title:t,value:e,isActive:o})=>[N]),tab5:a(({title:t,value:e,isActive:o})=>[O]),tab6:a(({title:t,value:e,isActive:o})=>[I]),_:1}),S,c(l,{data:[{title:"aeEventLoop"},{title:"select"},{title:"epoll"}],"tab-id":"code3"},{tab0:a(({title:t,value:e,isActive:o})=>[P]),tab1:a(({title:t,value:e,isActive:o})=>[D]),tab2:a(({title:t,value:e,isActive:o})=>[B]),_:1}),F,x,c(l,{data:[{title:"\u63A5\u6536\u8BF7\u6C42"},{title:"\u8FD4\u56DE\u54CD\u5E94"}],"tab-id":"code10"},{tab0:a(({title:t,value:e,isActive:o})=>[U]),tab1:a(({title:t,value:e,isActive:o})=>[M]),_:1}),z,j,c(l,{data:[{title:"processCommand"},{title:"queueMultiCommand"},{title:"call"}],"tab-id":"code4"},{tab0:a(({title:t,value:e,isActive:o})=>[G]),tab1:a(({title:t,value:e,isActive:o})=>[n("ul",null,[n("li",null,[n("a",W,[K,c(p)])])]),V]),tab2:a(({title:t,value:e,isActive:o})=>[H]),_:1})])}var J=r(v,[["render",q],["__file","server.html.vue"]]);export{J as default};
